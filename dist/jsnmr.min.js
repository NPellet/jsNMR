/*! jsNMR 0.0.4 | (c) 2014 Norman Pellet | http://github.com/NPellet/jsNMR/copyright.txt */
define(["jquery","jsgraph","jcampconverter"],function(t,e,i){var n,r,s;return function(t){function e(t,e){return x.call(t,e)}function i(t,e){var i,n,r,s,a,o,h,p,l,u,g,d,c=e&&e.split("/"),f=v.map,m=f&&f["*"]||{};if(t){for(t=t.split("/"),a=t.length-1,v.nodeIdCompat&&A.test(t[a])&&(t[a]=t[a].replace(A,"")),"."===t[0].charAt(0)&&c&&(d=c.slice(0,c.length-1),t=d.concat(t)),l=0;l<t.length;l++)if(g=t[l],"."===g)t.splice(l,1),l-=1;else if(".."===g){if(0===l||1===l&&".."===t[2]||".."===t[l-1])continue;l>0&&(t.splice(l-1,2),l-=2)}t=t.join("/")}if((c||m)&&f){for(i=t.split("/"),l=i.length;l>0;l-=1){if(n=i.slice(0,l).join("/"),c)for(u=c.length;u>0;u-=1)if(r=f[c.slice(0,u).join("/")],r&&(r=r[n])){s=r,o=l;break}if(s)break;!h&&m&&m[n]&&(h=m[n],p=l)}!s&&h&&(s=h,o=p),s&&(i.splice(0,o,s),t=i.join("/"))}return t}function a(e,i){return function(){var n=S.call(arguments,0);return"string"!=typeof n[0]&&1===n.length&&n.push(null),d.apply(t,n.concat([e,i]))}}function o(t){return function(e){return i(e,t)}}function h(t){return function(e){m[t]=e}}function p(i){if(e(b,i)){var n=b[i];delete b[i],y[i]=!0,g.apply(t,n)}if(!e(m,i)&&!e(y,i))throw new Error("No "+i);return m[i]}function l(t){var e,i=t?t.indexOf("!"):-1;return i>-1&&(e=t.substring(0,i),t=t.substring(i+1,t.length)),[e,t]}function u(t){return function(){return v&&v.config&&v.config[t]||{}}}var g,d,c,f,m={},b={},v={},y={},x=Object.prototype.hasOwnProperty,S=[].slice,A=/\.js$/;c=function(t,e){var n,r=l(t),s=r[0];return t=r[1],s&&(s=i(s,e),n=p(s)),s?t=n&&n.normalize?n.normalize(t,o(e)):i(t,e):(t=i(t,e),r=l(t),s=r[0],t=r[1],s&&(n=p(s))),{f:s?s+"!"+t:t,n:t,pr:s,p:n}},f={require:function(t){return a(t)},exports:function(t){var e=m[t];return"undefined"!=typeof e?e:m[t]={}},module:function(t){return{id:t,uri:"",exports:m[t],config:u(t)}}},g=function(i,n,r,s){var o,l,u,g,d,v,x=[],S=typeof r;if(s=s||i,"undefined"===S||"function"===S){for(n=!n.length&&r.length?["require","exports","module"]:n,d=0;d<n.length;d+=1)if(g=c(n[d],s),l=g.f,"require"===l)x[d]=f.require(i);else if("exports"===l)x[d]=f.exports(i),v=!0;else if("module"===l)o=x[d]=f.module(i);else if(e(m,l)||e(b,l)||e(y,l))x[d]=p(l);else{if(!g.p)throw new Error(i+" missing "+l);g.p.load(g.n,a(s,!0),h(l),{}),x[d]=m[l]}u=r?r.apply(m[i],x):void 0,i&&(o&&o.exports!==t&&o.exports!==m[i]?m[i]=o.exports:u===t&&v||(m[i]=u))}else i&&(m[i]=r)},n=r=d=function(e,i,n,r,s){if("string"==typeof e)return f[e]?f[e](i):p(c(e,i).f);if(!e.splice){if(v=e,v.deps&&d(v.deps,v.callback),!i)return;i.splice?(e=i,i=n,n=null):e=t}return i=i||function(){},"function"==typeof n&&(n=r,r=s),r?g(t,e,i,n):setTimeout(function(){g(t,e,i,n)},4),d},d.config=function(t){return d(t)},n._defined=m,s=function(t,i,n){if("string"!=typeof t)throw new Error("See almond README: incorrect module build, no module name");i.splice||(n=i,i=[]),e(m,t)||e(b,t)||(b[t]=[t,i,n])},s.amd={jQuery:!0}}(),s("build_utils/almond",function(){}),s("shape.1dnmr",["jquery","jsgraph"],function(t,e){"use strict";function i(t,e){this.options=e||2}var n=5,r=e.getConstructor("graph.shape.line");return t.extend(i.prototype,r.prototype,{createDom:function(){this._createHandles(2,"rect",{transform:"translate(-3 -3)",width:6,height:6,stroke:"black",fill:"white",cursor:"nwse-resize"}),this._dom=document.createElementNS(this.graph.ns,"line"),this.maxLines=64,this.nbLines=0,this.maxLines=0,this.lines=new Array(this.maxLines);for(var t=this.maxLines-1;t>=0;t--)this.lines[t]=document.createElementNS(this.graph.ns,"line"),this.group.appendChild(this.lines[t]),this.lines[t].setAttribute("stroke","green");var e,i=0,n=0,r=0,s=this.graph.series[0].data[0];for(e=0;e<s.length;e+=2)Math.abs(s[e+1])>r&&(r=Math.abs(s[e+1]));for(e=0;e<s.length;e+=2)i+=s[e+1]/r;for(e=0;e<s.length;e+=2)n+=Math.pow(i-s[e+1]/r,2);n=Math.sqrt(r)*Math.sqrt(2*n/s.length),this.noiseLevel=3*n,this._dom.element=this},redrawImpl:function(){this.setHandles(),this.redrawLines(n)},redrawLines:function(t){if(0!=this.maxLines){for(var e=this.findxs(),i=e.length-1;i>=0;i--){var n=this._getPosition({x:10}),r=this._getPosition({x:e[i][0]});this.lines[i]&&r.x&&this.currentPos2y&&this.currentPos1y&&i<this.maxLines&&(this.lines[i].setAttribute("stroke","green"),this.lines[i].setAttribute("x1",r.x),this.lines[i].setAttribute("x2",r.x),this.lines[i].setAttribute("y1",r.y),this.lines[i].setAttribute("y2",n.y),this.lines[i].setAttribute("on",!0))}for(var i=e.length;i<this.nbLines;i++)this.lines[i]&&(this.lines[i].setAttribute("y1",parseFloat(this.lines[i].getAttribute("y2"))),this.lines[i].setAttribute("x1",-1e6),this.lines[i].setAttribute("x2",-1e6),this.lines[i].setAttribute("on",!1));this.nbLines=e.length}},highLigthLinesY:function(t){for(var e=this.lines.length-1;e>=0;e--)"true"==this.lines[e].getAttribute("on")&&this.lines[e].setAttribute("y1",parseFloat(this.lines[e].getAttribute("y1"))-t)},findxs:function(){var t,e,i=this.serie.searchClosestValue(this.getFromData("pos").x),n=this.serie.searchClosestValue(this.getFromData("pos2").x),r=[],s=[];if(!i||!n)return!1;for(var a=i.dataIndex;a<=n.dataIndex;a++)for(t=a==i.dataIndex?i.xBeforeIndexArr:0,e=a==n.dataIndex?n.xBeforeIndexArr:this.serie.data[a].length,A=0,g=t;e>=g;g+=2)r.push(this.serie.data[a][g+0]),s.push(this.serie.data[a][g+1]);for(var a=s.length-1;a>=0;a--)Math.abs(s[a])<this.noiseLevel&&(s[a]=0);for(var o=r[1]-r[0],h=[],p=[],l=[],u=[],g=2;g<r.length-2;g++)p.push(1/35*(-3*s[g-2]+12*s[g-1]+17*s[g]+12*s[g+1]-3*s[g+2])),h.push(r[g]),l.push(1/(12*o)*(s[g-2]-8*s[g-1]+8*s[g+1]-s[g+2])),u.push(1/(7*Math.abs(2*o))*(2*s[g-2]-s[g-1]-2*s[g]-s[g+1]+2*s[g+2]));for(var d=[],c=[],f=[],m=[],a=1;a<p.length-1;a++){if(p[a]>p[a-1]&&p[a]>p[a+1]&&d.push(h[a]),l[a]<l[a-1]&&l[a]<l[a+1]&&c.push(h[a]),l[a]>l[a-1]&&l[a]>l[a+1])try{f.push([h[a],c.pop()])}catch(b){console.log("Error I don't know why")}u[a]<u[a-1]&&u[a]<u[a+1]&&m.push([h[a],p[a]])}for(var v=new Array,g=0;g<m.length;g++){for(var y=m[g],x=y[0],S=new Array,A=0;A<f.length;A++){var a=f[A];x>a[0]&&x<a[1]&&S.push(a)}if(S.length>0&&1==S.length){var w=S[0],j=w[1]-w[0],G=y[1],k=p;k.sort(function(t,e){return t-e}),j>2*o&&G>1e-4*k[0]&&v.push([x,j,G])}}return v}}),i}),s("assignment",["jquery"],function(t){"use strict";var e="http://www.w3.org/2000/svg",i=function(i){var n=this;this.options=i,this.bindingPairs=[];var r,s,a=!1,o=!1,h=!1,p={},l=[],u=[],g=function(e,o,h){if(P(),o.shiftKey){for(var p in i.graphs)i.graphs[p].lockShapes();a=!0,n[h]=e,o.preventDefault(),o.stopPropagation()}var l=e.getBBox(),u=t(e).position(),g=u.left+l.width/2,f=u.top+l.height/2;if(r.setAttribute("display","block"),r.setAttribute("x1",g),r.setAttribute("x2",g),r.setAttribute("y1",f),r.setAttribute("y2",f),s=d(h),i[d(h)].targettable){var m=c(d(h));m.each(function(){this.jsGraphIsShape?this.jsGraphIsShape.highlight(i[d(h)].targettable,"binding"):(S(i[d(h)].targettable,t(this)),t(this).attr(i[d(h)].targettable))})}},d=function(t){return"jsGraphShape"==t?"targetB":"jsGraphShape"},c=function(e){return t(i[e].dom).find(i[e].bindableFilter)},f=function(e,o,h){if(P(),s&&i[s].targettable){var p=c(s);p.each(function(){this.jsGraphIsShape?this.jsGraphIsShape.unHighlight("binding"):A(i[s].targettable,t(this))})}if(s=!1,a&&!h)return r.setAttribute("display","none"),void(a=!1);if(a){var l=o.target;r.setAttribute("display","none"),!t(l).is(i[h].bindableFilter)&&!t(l).get(0).classList.contains(i[h].bindableFilterClass)>-1?a=!1:(n[h]=o.target,a=!1,k());for(var u in i.graphs)i.graphs[u].unlockShapes()}},m=function(t){P(),a&&(r.setAttribute("x2",t.clientX+window.scrollX),r.setAttribute("y2",t.clientY+window.scrollY))},b=function(e,n){P();var r=[e];i[n].highlighted&&(r=x(n,e),y(n,r));for(var s=[],a=0,o=r.length;o>a;a++)w(j,r[a],function(e){s=s.concat(t.makeArray(x(d(n),e[d(n)])))});s=t(s),i[d(n)].highlighted&&y(d(n),s)},v=function(e,n,r){P();for(var s=x(n,e),a=[],o=0;o<s.length;o++)w(G,s[o],function(e){a=a.concat(t.makeArray(x(d(n),e[d(n)])))});p.jsGraphShape.map(function(t){this.jsGraphIsShape.unHighlight("assignmentHighlighted")}),A(i.targetB.highlighted,p.targetB)},y=function(t,e){var n=i[t].highlighted;e[0]&&e[0].jsGraphIsShape?e.map(function(t){this.jsGraphIsShape.highlight(n,"assignmentHighlighted")}):(S(n,e),e.attr(n)),p[t]=e},x=function(e,n){var r=n.getAttribute(i[e].attributeEquivalents);return t(i[e].dom).find("["+i[e].attributeEquivalents+'="'+r+'"]')},S=function(e,i){for(var n in e)for(var r=0,s=i.length;s>r;r++)t(i[r]).data("backup-"+n)||t(i[r]).data("backup-"+n,t(i[r]).attr(n))},A=function(e,i){for(var n in e)for(var r=0,s=i.length;s>r;r++)t(i[r]).attr(n,t(i[r]).data("backup-"+n))},w=function(t,e,i){for(var r=0,s=n.bindingPairs.length;s>r;r++)(n.bindingPairs[r].jsGraphShape==e||n.bindingPairs[r].targetB==e)&&(t(n.bindingPairs[r]),i&&i(n.bindingPairs[r]))},j=function(n){var r,s=t(n.jsGraphShape).offset(),a=t(n.targetB).offset(),o=t(n.jsGraphShape)[0].getBBox(),h=t(n.targetB)[0].getBBox(),p=i.domGlobal.offset();l.length>0?(r=l.pop(),r.setAttribute("display","block")):r=document.createElementNS(e,"line"),r.setAttribute("stroke","black"),r.setAttribute("x1",s.left-p.left+o.width/2),r.setAttribute("y1",s.top-p.top+o.height/2),r.setAttribute("x2",a.left-p.left+h.width/2),r.setAttribute("y2",a.top-p.top+h.height/2),n.line=r,u.push(r),C.appendChild(r)},G=function(t){t.line=!1,u.map(function(t){t.setAttribute("display","none")}),l=l.concat(u),u=[]},k=function(){var t;return(t=L(n.jsGraphShape,n.targetB))?(B(t),G(t),!1):(v(n.jsGraphShape,"jsGraphShape",!0),n.bindingPairs.push({jsGraphShape:n.jsGraphShape,targetB:n.targetB}),n.jsGraphShape.jsGraphIsShape.setStrokeDasharray("5,5"),n.jsGraphShape.jsGraphIsShape.applyStyle(),o=null,h=null,void console.log(n.getAssignment()))},B=function(t){n.bindingPairs.splice(n.bindingPairs.indexOf(t),1)},L=function(t,e){return n.bindingPairs.map(function(i){return i.jsGraphShape==t||i.targetB==e?i:void 0}),!1},P=function(){for(var e=0,r=n.bindingPairs.length;r>e;e++)t(i.jsGraphShape.dom).get(0).contains(n.bindingPairs[e].jsGraphShape)&&t(i.targetB.dom).get(0).contains(n.bindingPairs[e].targetB)||(n.bindingPairs[e]=!1)},D=function(){i.jsGraphShape.dom.on("mousedown",i.jsGraphShape.bindableFilter,function(t){g(this,t,"jsGraphShape")}),i.jsGraphShape.dom.on("mouseover",i.jsGraphShape.bindableFilter,function(t){b(this,"jsGraphShape")}),i.jsGraphShape.dom.on("mouseout",i.jsGraphShape.bindableFilter,function(t){v(this,"jsGraphShape")}),i.targetB.dom.on("mousedown",i.targetB.bindableFilter,function(t){g(this,t,"targetB")}),i.targetB.dom.on("mouseover",i.targetB.bindableFilter,function(t){b(this,"targetB")}),i.targetB.dom.on("mouseout",i.targetB.bindableFilter,function(t){v(this,"targetB")}),i.jsGraphShape.dom.on("mouseup",function(t){f(this,t,"jsGraphShape")}),i.targetB.dom.on("mouseup",function(t){f(this,t,"targetB")}),i.domGlobal.on("mouseup",function(t){f(this,t,!1)}),i.domGlobal.on("mousemove",function(t){m(t)})},C=document.createElementNS(e,"svg");C.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),C.setAttribute("xmlns",e),C.setAttribute("style","position: absolute"),C.setAttribute("width",i.domGlobal.width()),C.setAttribute("height",i.domGlobal.height()),C.setAttribute("pointer-events","none"),r=document.createElementNS(e,"line"),r.setAttribute("stroke","black"),C.appendChild(r),i.domGlobal.prepend(C),D()};return i.prototype.getAssignment=function(){var t=this;return this.bindingPairs.map(function(e){if(e){var i=e.jsGraphShape.getAttribute(t.options.jsGraphShape.attributeEquivalents),n=e.targetB.getAttribute(t.options.targetB.attributeEquivalents);return[i,n]}})},i.prototype.findElement=function(e,i){return t(this.options[e].dom).find("["+this.options[e].attributeEquivalents+'="'+i+'"]')},i.prototype.setAssignment=function(t){var e=this;e.bindingPairs=[],t.forEach(function(t){e.bindingPairs.push({jsGraphShape:e.findElement("jsGraphShape",t[0]),targetB:e.findElement("targetB",t[1])})})},i}),s("nmr",["jquery","jsgraph","./shape.1dnmr","./assignment","jcampconverter"],function(t,e,i,n,r){function s(e,i,n){var s=[];for(var a in i)s.push(t.get(i[a]).then(function(t){return r.convert(t,{keepSpectra:!0})}));e.divLoading||(e.divLoading=t("<div />").css({width:e.getDom().width(),height:e.getDom().height(),position:"absolute",backgroundColor:"rgba(200, 200, 200, 0.5)",textAlign:"center",lineHeight:e.getDom().height()+"px",fontSize:"2em",border:"1px solid #c0c0c0"}).html("Loading..."),e.getDom().prepend(e.divLoading)),e.loading=e.loading||0,e.loading++,t.when.apply(t,s).then(function(){var t=0;for(a in i)i[a]=arguments[t],t++;e.loading--,0==e.loading&&(e.divLoading.remove(),e.divLoading=!1),e.series.push(i),e.loaded(i,n,"a"+Math.random())})}function a(t,e,i){var n=c.length;1==n&&(u=150/c[0].sum,g=c[0].sum);for(var r=0;n>r;r++){c[r].ratio=u;var s=Math.round(c[r].sum/g*100)/100;isNaN(s)||c[r].setLabelText(s),c[r].updateLabels()}}function o(t,e,i){f.push(i),t.graphs.selectedSerie?i.setSerie(t.graphs.selectedSerie):i.setSerie(t.graphs.getSerie(0)),i.integral=i,c.push(i)}function h(t,e,i){var n;(n=t.graphs[e].getSerie(i))&&n.kill(),t.graphs[e].redraw(),t.graphs[e].drawSeries()}function p(t){t.options.dom.append("<div />"),t.makeGraphs1D()}function l(e){switch(this.options=t.extend(!0,{},d,e),this.series=[],this.graphs={x:null},this.integrals={x:[]},p(this),this.options.mode){case"2d":break;case"1d":this.legend=this.graphs.makeLegend({frame:!0,frameWidth:2,frameColor:"grey",movable:!0,backgroundColor:"white"}),this.legend.setPosition({x:"300px",y:"40px"},"right")}this.options.assignment&&(this.assignement=new n(t.extend(this.options.assignment,{graphs:this.graphs,domGraphs:this.options.dom})))}var u,g,d={mode:"1d",molecule:!1,urls:{}},c=[],f=[];e.registerConstructor("graph.shape.1dnmr",i);var m={urls:{}};return l.prototype.load=function(e){var e=t.extend(!0,{},m,e),i={};switch(this.options.mode){case"1d":e.urls.oneD=e.url||e.urls.oneD||e.urls.x,i.x=e.urls.oneD}s(this,i,e)},l.prototype.isSymmetric=function(){return this.options.symmetric||!1},l.prototype.getMode=function(){return this.options.mode},l.prototype.getDom=function(){return this.options.dom},l.prototype.getGraph2D=function(){return this.graphs._2d},l.prototype.getGraphX=function(){return this.graphs.x},l.prototype.getGraphY=function(){return this.graphs.y},l.prototype.resize1DTo=function(t,e){this.graphs.resize(t,e),this.graphs.drawSeries()},l.prototype.removeSerieX=function(t){h(this,"x",t)},l.prototype.setSerieX=function(e,i,n){this.graphs.getSerie(e)&&(this.graphs.getSerie(e).kill(),this.graphs.removeShapes(),this.integralBasis=!1);var r=this.graphs.newSerie(e,t.extend({useSlots:!0},n)).setLabel("My serie").autoAxis().setData(i).XIsMonotoneous();n.lineColor&&r.setLineColor(n.lineColor),n.lineWidth&&r.setLineWidth(n.lineWidth),n.setLineStyle&&r.setLineStyle(n.lineStyle),r.XIsMonotoneous(),r.getXAxis().setAxisDataSpacingMax(0),r.getXAxis().setAxisDataSpacingMin(0),r.getYAxis().setDisplay(!1).primaryGridOff(!1).secondaryGridOff(!1),r.getXAxis().flip(!0).setLabel("ppm").primaryGridOff(!1).secondaryGridOff(!1).setTickPosition("outside"),this.graphs.autoscaleAxes(),this.graphs.draw()},l.prototype.loaded=function(t,e,i){switch(this.getMode()){case"1d":this.setSerieX(i,t.x.spectra[0].data[0],{label:"SomeLabel"})}},l.prototype.makeGraphs1D=function(){var t=this;this.graphs=new e(this.getDom().children().get(0),{close:{left:!1,top:!1,right:!1},paddingBottom:0,paddingTop:0,paddingLeft:0,paddingRight:0,plugins:{zoom:{zoomMode:"x"},shape:{type:"nmrintegral",strokeColor:"#AF002A",fillColor:"transparent",strokeWidth:2,locked:!1,movable:!0,resizable:!0,selectable:!0,selectOnMouseDown:!0,handles:!0,labelEditable:!0,horizontal:!0,forcedCoords:{y:function(t){return 20+5*t.serie.getIndex()+"px"}},bindable:!0,axis:"x",labels:[{text:"Something",color:"red"}],attributes:{"data-bindable":function(){return 1}},onCreatedShape:function(e){e.setSerie(t.graphs.getSerie(0)),o(t,"x",e)},highlightOnMouseOver:!0}},dblclick:{type:"plugin",plugin:"zoom",options:{mode:"total"}},wheel:{type:"plugin",plugin:"zoom",options:{direction:"y",baseline:0}},pluginAction:{zoom:{shift:!1,ctrl:!1},shape:{shift:!0,ctrl:!1}},onBeforeNewShape:function(){return!this.selectedSerie&&this.series.length>1?!1:void 0}}),this.graphs.setHeight(300),this.graphs.on("shapeChanged",function(e){"nmrintegral"==e.getType()&&a(t)}),this.graphs.on("shapeLabelChanged",function(e){if("nmrintegral"==e.getType()){var i=parseFloat(e.getLabelText(0));g=e.sum/i,a(t)}}),this.graphs.redraw(),this.graphs.drawSeries()},l}),s("jquery",function(){return t}),s("jsgraph",function(){return e}),s("jcampconverter",function(){return i}),r("nmr")});
//# sourceMappingURL=jsnmr.min.js.map