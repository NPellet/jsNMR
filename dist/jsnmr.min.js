/*! jsNMR 0.0.11 | (c) 2014 Norman Pellet | http://github.com/NPellet/jsNMR/copyright.txt */
define(["jquery","jsgraph","jcampconverter","eventEmitter"],function(t,e,i,n){var r,s,a;return function(t){function e(t,e){return S.call(t,e)}function i(t,e){var i,n,r,s,a,o,h,l,p,u,g,d,c=e&&e.split("/"),f=v.map,m=f&&f["*"]||{};if(t){for(t=t.split("/"),a=t.length-1,v.nodeIdCompat&&A.test(t[a])&&(t[a]=t[a].replace(A,"")),"."===t[0].charAt(0)&&c&&(d=c.slice(0,c.length-1),t=d.concat(t)),p=0;p<t.length;p++)if(g=t[p],"."===g)t.splice(p,1),p-=1;else if(".."===g){if(0===p||1===p&&".."===t[2]||".."===t[p-1])continue;p>0&&(t.splice(p-1,2),p-=2)}t=t.join("/")}if((c||m)&&f){for(i=t.split("/"),p=i.length;p>0;p-=1){if(n=i.slice(0,p).join("/"),c)for(u=c.length;u>0;u-=1)if(r=f[c.slice(0,u).join("/")],r&&(r=r[n])){s=r,o=p;break}if(s)break;!h&&m&&m[n]&&(h=m[n],l=p)}!s&&h&&(s=h,o=l),s&&(i.splice(0,o,s),t=i.join("/"))}return t}function n(e,i){return function(){var n=x.call(arguments,0);return"string"!=typeof n[0]&&1===n.length&&n.push(null),d.apply(t,n.concat([e,i]))}}function o(t){return function(e){return i(e,t)}}function h(t){return function(e){m[t]=e}}function l(i){if(e(b,i)){var n=b[i];delete b[i],y[i]=!0,g.apply(t,n)}if(!e(m,i)&&!e(y,i))throw new Error("No "+i);return m[i]}function p(t){var e,i=t?t.indexOf("!"):-1;return i>-1&&(e=t.substring(0,i),t=t.substring(i+1,t.length)),[e,t]}function u(t){return function(){return v&&v.config&&v.config[t]||{}}}var g,d,c,f,m={},b={},v={},y={},S=Object.prototype.hasOwnProperty,x=[].slice,A=/\.js$/;c=function(t,e){var n,r=p(t),s=r[0];return t=r[1],s&&(s=i(s,e),n=l(s)),s?t=n&&n.normalize?n.normalize(t,o(e)):i(t,e):(t=i(t,e),r=p(t),s=r[0],t=r[1],s&&(n=l(s))),{f:s?s+"!"+t:t,n:t,pr:s,p:n}},f={require:function(t){return n(t)},exports:function(t){var e=m[t];return"undefined"!=typeof e?e:m[t]={}},module:function(t){return{id:t,uri:"",exports:m[t],config:u(t)}}},g=function(i,r,s,a){var o,p,u,g,d,v,S=[],x=typeof s;if(a=a||i,"undefined"===x||"function"===x){for(r=!r.length&&s.length?["require","exports","module"]:r,d=0;d<r.length;d+=1)if(g=c(r[d],a),p=g.f,"require"===p)S[d]=f.require(i);else if("exports"===p)S[d]=f.exports(i),v=!0;else if("module"===p)o=S[d]=f.module(i);else if(e(m,p)||e(b,p)||e(y,p))S[d]=l(p);else{if(!g.p)throw new Error(i+" missing "+p);g.p.load(g.n,n(a,!0),h(p),{}),S[d]=m[p]}u=s?s.apply(m[i],S):void 0,i&&(o&&o.exports!==t&&o.exports!==m[i]?m[i]=o.exports:u===t&&v||(m[i]=u))}else i&&(m[i]=s)},r=s=d=function(e,i,n,r,s){if("string"==typeof e)return f[e]?f[e](i):l(c(e,i).f);if(!e.splice){if(v=e,v.deps&&d(v.deps,v.callback),!i)return;i.splice?(e=i,i=n,n=null):e=t}return i=i||function(){},"function"==typeof n&&(n=r,r=s),r?g(t,e,i,n):setTimeout(function(){g(t,e,i,n)},4),d},d.config=function(t){return d(t)},r._defined=m,a=function(t,i,n){if("string"!=typeof t)throw new Error("See almond README: incorrect module build, no module name");i.splice||(n=i,i=[]),e(m,t)||e(b,t)||(b[t]=[t,i,n])},a.amd={jQuery:!0}}(),a("build_utils/almond",function(){}),a("shape.1dnmr",["jquery","jsgraph"],function(t,e){"use strict";function i(t,e){this.options=e||2}var n=5,r=e.getConstructor("graph.shape.line");return t.extend(i.prototype,r.prototype,{createDom:function(){this._createHandles(2,"rect",{transform:"translate(-3 -3)",width:6,height:6,stroke:"black",fill:"white",cursor:"nwse-resize"}),this._dom=document.createElementNS(this.graph.ns,"line"),this.maxLines=64,this.nbLines=0,this.maxLines=0,this.lines=new Array(this.maxLines);for(var t=this.maxLines-1;t>=0;t--)this.lines[t]=document.createElementNS(this.graph.ns,"line"),this.group.appendChild(this.lines[t]),this.lines[t].setAttribute("stroke","green");var e,i=0,n=0,r=0,s=this.graph.series[0].data[0];for(e=0;e<s.length;e+=2)Math.abs(s[e+1])>r&&(r=Math.abs(s[e+1]));for(e=0;e<s.length;e+=2)i+=s[e+1]/r;for(e=0;e<s.length;e+=2)n+=Math.pow(i-s[e+1]/r,2);n=Math.sqrt(r)*Math.sqrt(2*n/s.length),this.noiseLevel=3*n,this._dom.element=this},redrawImpl:function(){this.setHandles(),this.redrawLines(n)},redrawLines:function(t){if(0!=this.maxLines){for(var e=this.findxs(),i=e.length-1;i>=0;i--){var n=this._getPosition({x:10}),r=this._getPosition({x:e[i][0]});this.lines[i]&&r.x&&this.currentPos2y&&this.currentPos1y&&i<this.maxLines&&(this.lines[i].setAttribute("stroke","green"),this.lines[i].setAttribute("x1",r.x),this.lines[i].setAttribute("x2",r.x),this.lines[i].setAttribute("y1",r.y),this.lines[i].setAttribute("y2",n.y),this.lines[i].setAttribute("on",!0))}for(var i=e.length;i<this.nbLines;i++)this.lines[i]&&(this.lines[i].setAttribute("y1",parseFloat(this.lines[i].getAttribute("y2"))),this.lines[i].setAttribute("x1",-1e6),this.lines[i].setAttribute("x2",-1e6),this.lines[i].setAttribute("on",!1));this.nbLines=e.length}},highLigthLinesY:function(t){for(var e=this.lines.length-1;e>=0;e--)"true"==this.lines[e].getAttribute("on")&&this.lines[e].setAttribute("y1",parseFloat(this.lines[e].getAttribute("y1"))-t)},findxs:function(){var t,e,i=this.serie.searchClosestValue(this.getFromData("pos").x),n=this.serie.searchClosestValue(this.getFromData("pos2").x),r=[],s=[];if(!i||!n)return!1;for(var a=i.dataIndex;a<=n.dataIndex;a++)for(t=a==i.dataIndex?i.xBeforeIndexArr:0,e=a==n.dataIndex?n.xBeforeIndexArr:this.serie.data[a].length,A=0,g=t;e>=g;g+=2)r.push(this.serie.data[a][g+0]),s.push(this.serie.data[a][g+1]);for(var a=s.length-1;a>=0;a--)Math.abs(s[a])<this.noiseLevel&&(s[a]=0);for(var o=r[1]-r[0],h=[],l=[],p=[],u=[],g=2;g<r.length-2;g++)l.push(1/35*(-3*s[g-2]+12*s[g-1]+17*s[g]+12*s[g+1]-3*s[g+2])),h.push(r[g]),p.push(1/(12*o)*(s[g-2]-8*s[g-1]+8*s[g+1]-s[g+2])),u.push(1/(7*Math.abs(2*o))*(2*s[g-2]-s[g-1]-2*s[g]-s[g+1]+2*s[g+2]));for(var d=[],c=[],f=[],m=[],a=1;a<l.length-1;a++){if(l[a]>l[a-1]&&l[a]>l[a+1]&&d.push(h[a]),p[a]<p[a-1]&&p[a]<p[a+1]&&c.push(h[a]),p[a]>p[a-1]&&p[a]>p[a+1])try{f.push([h[a],c.pop()])}catch(b){console.log("Error I don't know why")}u[a]<u[a-1]&&u[a]<u[a+1]&&m.push([h[a],l[a]])}for(var v=new Array,g=0;g<m.length;g++){for(var y=m[g],S=y[0],x=new Array,A=0;A<f.length;A++){var a=f[A];S>a[0]&&S<a[1]&&x.push(a)}if(x.length>0&&1==x.length){var w=x[0],j=w[1]-w[0],G=y[1],L=l;L.sort(function(t,e){return t-e}),j>2*o&&G>1e-4*L[0]&&v.push([S,j,G])}}return v}}),i}),a("assignment",["jquery"],function(t){"use strict";var e="http://www.w3.org/2000/svg",i=function(i){var n=this;this.options=i,this.bindingPairs=[],this.stashedLines=[],this.currentLines=[];var r,s,a=!1,o=!1,h=!1,l={},p=function(e,o,h){if(G(),o.shiftKey){for(var l in i.graphs)i.graphs[l].lockShapes();a=!0,n[h]=e,o.preventDefault(),o.stopPropagation()}var p=e.getBBox(),d=t(e).position(),c=d.left+p.width/2,f=d.top+p.height/2;if(r.setAttribute("display","block"),r.setAttribute("x1",c),r.setAttribute("x2",c),r.setAttribute("y1",f),r.setAttribute("y2",f),s=u(h),i[u(h)].targettable){var m=g(u(h));m.each(function(){this.jsGraphIsShape?this.jsGraphIsShape.highlight(i[u(h)].targettable,"binding"):(y(i[u(h)].targettable,t(this)),t(this).attr(i[u(h)].targettable))})}},u=function(t){return"jsGraphShape"==t?"targetB":"jsGraphShape"},g=function(e){return t(i[e].dom).find(i[e].bindableFilter)},d=function(e,o,h){if(G(),s&&i[s].targettable){var l=g(s);l.each(function(){this.jsGraphIsShape?this.jsGraphIsShape.unHighlight("binding"):S(i[s].targettable,t(this))})}if(s=!1,a&&!h)return r.setAttribute("display","none"),void(a=!1);if(a){var p=o.target;r.setAttribute("display","none"),!t(p).is(i[h].bindableFilter)&&!t(p).get(0).classList.contains(i[h].bindableFilterClass)>-1?a=!1:(n[h]=o.target,a=!1,w());for(var u in i.graphs)i.graphs[u].unlockShapes()}},c=function(t){G(),a&&(r.setAttribute("x2",t.clientX+window.scrollX),r.setAttribute("y2",t.clientY+window.scrollY))},f=function(e,n){G();var r=[e];i[n].highlighted&&(r=v(n,e),b(n,r));for(var s=[],a=0,o=r.length;o>a;a++)x(A,r[a],function(e){s=s.concat(t.makeArray(v(u(n),e[u(n)])))});s=t(s),i[u(n)].highlighted&&b(u(n),s)},m=function(e,r,s){G();for(var a=v(r,e),o=[],h=0;h<a.length;h++)x(n.unhighlightPair,a[h],function(e){o=o.concat(t.makeArray(v(u(r),e[u(r)])))});l.jsGraphShape.map(function(t){this.jsGraphIsShape.unHighlight("assignmentHighlighted")}),S(i.targetB.highlighted,l.targetB)},b=function(t,e){var n=i[t].highlighted;e[0]&&e[0].jsGraphIsShape?e.map(function(t){this.jsGraphIsShape.highlight(n,"assignmentHighlighted")}):(y(n,e),e.attr(n)),l[t]=e},v=function(e,n){var r=n.getAttribute(i[e].attributeEquivalents);return t(i[e].dom).find("["+i[e].attributeEquivalents+'="'+r+'"]')},y=function(e,i){for(var n in e)for(var r=0,s=i.length;s>r;r++)t(i[r]).data("backup-"+n)||t(i[r]).data("backup-"+n,t(i[r]).attr(n))},S=function(e,i){for(var n in e)for(var r=0,s=i.length;s>r;r++)t(i[r]).attr(n,t(i[r]).data("backup-"+n))},x=function(t,e,i){for(var r=0,s=n.bindingPairs.length;s>r;r++)(n.bindingPairs[r].jsGraphShape==e||n.bindingPairs[r].targetB==e)&&(t.call(n,n.bindingPairs[r]),i&&i.call(n,n.bindingPairs[r]))},A=function(r){var s,a=t(r.jsGraphShape).offset(),o=t(r.targetB).offset(),h=t(r.jsGraphShape)[0].getBBox(),l=t(r.targetB)[0].getBBox(),p=i.domGlobal.offset();n.stashedLines.length>0?(s=n.stashedLines.pop(),s.setAttribute("display","block")):s=document.createElementNS(e,"line"),s.setAttribute("stroke","black"),s.setAttribute("x1",a.left-p.left+h.width/2),s.setAttribute("y1",a.top-p.top+h.height/2),s.setAttribute("x2",o.left-p.left+l.width/2),s.setAttribute("y2",o.top-p.top+l.height/2),r.line=s,n.currentLines.push(s),P.appendChild(s)},w=function(){var t;return(t=j(n.jsGraphShape,n.targetB))?(removePair(t),n.unhighlightPair(t),!1):(m(n.jsGraphShape,"jsGraphShape",!0),n.bindingPairs.push({jsGraphShape:n.jsGraphShape,targetB:n.targetB}),n.jsGraphShape.jsGraphIsShape.setStrokeDasharray("5,5"),n.jsGraphShape.jsGraphIsShape.applyStyle(),o=null,void(h=null))},j=function(t,e){for(var i=0;i<n.bindingPairs.length;i++)if(n.bindingPairs[i].jsGraphShape==t||n.bindingPairs[i].targetB==e)return n.bindingPairs[i];return!1},G=function(){for(var e=0,r=n.bindingPairs.length;r>e;e++)t(i.jsGraphShape.dom).get(0).contains(n.bindingPairs[e].jsGraphShape)&&t(i.targetB.dom).get(0).contains(n.bindingPairs[e].targetB)||(n.bindingPairs[e]=!1)},L=function(){i.jsGraphShape.dom.on("mousedown",i.jsGraphShape.bindableFilter,function(t){p(this,t,"jsGraphShape")}),i.jsGraphShape.dom.on("mouseover",i.jsGraphShape.bindableFilter,function(t){f(this,"jsGraphShape")}),i.jsGraphShape.dom.on("mouseout",i.jsGraphShape.bindableFilter,function(t){m(this,"jsGraphShape")}),i.targetB.dom.on("mousedown",i.targetB.bindableFilter,function(t){p(this,t,"targetB")}),i.targetB.dom.on("mouseover",i.targetB.bindableFilter,function(t){f(this,"targetB")}),i.targetB.dom.on("mouseout",i.targetB.bindableFilter,function(t){m(this,"targetB")}),i.jsGraphShape.dom.on("mouseup",function(t){d(this,t,"jsGraphShape")}),i.targetB.dom.on("mouseup",function(t){d(this,t,"targetB")}),i.domGlobal.on("mouseup",function(t){d(this,t,!1)}),i.domGlobal.on("mousemove",function(t){c(t)})},P=document.createElementNS(e,"svg");P.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),P.setAttribute("xmlns",e),P.setAttribute("style","position: absolute"),P.setAttribute("width",i.domGlobal.width()),P.setAttribute("height",i.domGlobal.height()),P.setAttribute("pointer-events","none"),r=document.createElementNS(e,"line"),r.setAttribute("stroke","black"),P.appendChild(r),i.domGlobal.prepend(P),L()};return i.prototype.removePair=function(t){this.bindingPairs.splice(this.bindingPairs.indexOf(t),1),this.unhighlightPair(t)},i.prototype.unhighlightPair=function(t){t.line=!1,this.currentLines.map(function(t){t.setAttribute("display","none")}),this.stashedLines=this.stashedLines.concat(this.currentLines),this.currentLines=[]},i.prototype.getAssignment=function(){var t=this;return this.bindingPairs.map(function(e){if(e){var i=e.jsGraphShape.getAttribute(t.options.jsGraphShape.attributeEquivalents),n=e.targetB.getAttribute(t.options.targetB.attributeEquivalents);return[i,n]}})},i.prototype.removePairsWithShape=function(t){var e=this;this.lookForPairsByShape(t).map(function(t){e.removePair(t)})},i.prototype.lookForPairsByShape=function(t){for(var e=[],i=0;i<this.bindingPairs.length;i++)this.bindingPairs[i].jsGraphShape==t&&e.push(this.bindingPairs[i]);return e},i.prototype.findElement=function(e,i){return t(this.options[e].dom).find("["+this.options[e].attributeEquivalents+'="'+i+'"]')},i.prototype.setAssignment=function(t){var e=this;e.bindingPairs=[],t.forEach(function(t){e.bindingPairs.push({jsGraphShape:e.findElement("jsGraphShape",t[0]),targetB:e.findElement("targetB",t[1])})})},i}),a("nmr",["jquery","jsgraph","./shape.1dnmr","./assignment","jcampconverter","eventEmitter"],function(t,e,i,n,r,s){function a(e,i,n){var s=[];for(var a in i)s.push(t.get(i[a]).then(function(t){return r.convert(t,{keepSpectra:!0})}));e.divLoading||(e.divLoading=t("<div />").css({width:e.getDom().width(),height:e.getDom().height(),position:"absolute",backgroundColor:"rgba(200, 200, 200, 0.5)",textAlign:"center",lineHeight:e.getDom().height()+"px",fontSize:"2em",border:"1px solid #c0c0c0"}).html("Loading..."),e.getDom().prepend(e.divLoading)),e.loading=e.loading||0,e.loading++,t.when.apply(t,s).then(function(){var t=0;for(a in i)i[a]=arguments[t],t++;e.loading--,0==e.loading&&(e.divLoading.remove(),e.divLoading=!1),e.series.push(i),e.loaded(i,n,"a"+Math.random())})}function o(e){var i=this;switch(this.options=t.extend(!0,{},h,e),this.series=[],this.graphs,this.integrals=[],i.options.dom.append("<div />"),i.makeGraph(),this.options.mode){case"2d":break;case"1d":this.legend=this.graphs.makeLegend({frame:!0,frameWidth:2,frameColor:"grey",movable:!0,backgroundColor:"white"}),this.legend.setPosition({x:"300px",y:"40px"},"right")}this.options.assignment&&(this.assignement=new n(t.extend(this.options.assignment,{graphs:{x:this.graphs},domGraphs:this.options.dom}))),this.heightIntegral1=150}var h={mode:"1d",molecule:!1,urls:{}};e.registerConstructor("graph.shape.1dnmr",i);var l={urls:{}};return o.prototype=new s,o.prototype.load=function(e){var e=t.extend(!0,{},l,e),i={};switch(this.options.mode){case"1d":e.urls.oneD=e.url||e.urls.oneD||e.urls.x,i.x=e.urls.oneD}a(this,i,e)},o.prototype.integralCreated=function(t){this.graphs.selectedSerie?t.setSerie(this.graphs.selectedSerie):t.setSerie(this.graphs.getSerie(0)),t.addClass("bindable"),this.integrals.push(t),this.emit("integralCreated")},o.prototype.integralChanged=function(t){this.recalculateIntegrals(),this.emit("integralChanged")},o.prototype.integralRemoved=function(t){this.integrals.splice(this.integrals.indexOf(t),1),this.recalculateIntegrals(),this.assignement.removePairsWithShape(t._dom),this.emit("integralRemoved")},o.prototype.recalculateIntegrals=function(){var t=this,e=t.integrals.length;1==e&&(t.ratio=t.heightIntegral1/t.integrals[0].sum,t.ratioSum=t.integrals[0].sum);for(var i=0;e>i;i++){t.integrals[i].ratio=t.ratio;var n=Math.round(t.integrals[i].sum/t.ratioSum*100)/100;isNaN(n)||t.integrals[i].setLabelText(n),t.integrals[i].updateLabels()}},o.prototype.redrawIntegrals=function(){for(var t=this.integrals.length,e=0;t>e;e++)this.integrals[e].redraw()},o.prototype.integralValueChanged=function(t){var e=parseFloat(t.getLabelText(0));this.ratioSum=t.sum/e,this.recalculateIntegrals(),this.emit("integralValueChanged")},o.prototype.getDom=function(){return this.options.dom},o.prototype.getGraph=function(){return this.graphs},o.prototype.resizeTo=function(t,e){this.graphs.resize(t,e)},o.prototype.setSerieX=function(e,i,n){this.graphs.getSerie(e)&&(this.graphs.getSerie(e).kill(),this.graphs.removeShapes(),this.integralBasis=!1);var r=this.graphs.newSerie(e,t.extend({useSlots:!0},n)).setLabel("My serie").autoAxis().setData(i).XIsMonotoneous();n.lineColor&&r.setLineColor(n.lineColor),n.lineWidth&&r.setLineWidth(n.lineWidth),n.setLineStyle&&r.setLineStyle(n.lineStyle),r.XIsMonotoneous(),r.getXAxis().setAxisDataSpacingMax(0),r.getXAxis().setAxisDataSpacingMin(0),r.getYAxis().setDisplay(!1).primaryGridOff(!1).secondaryGridOff(!1),r.getXAxis().flip(!0).setLabel("ppm").primaryGridOff(!1).secondaryGridOff(!1).setTickPosition("outside"),this.graphs.autoscaleAxes(),this.graphs.draw()},o.prototype.loaded=function(t,e,i){this.setSerieX(i,t.x.spectra[0].data[0],{label:"SomeLabel"})},o.prototype.makeGraph=function(){var t=this;this.graphs=new e(this.getDom().children().get(0),{close:{left:!1,top:!1,right:!1},paddingBottom:0,paddingTop:0,paddingLeft:0,paddingRight:0,plugins:{zoom:{zoomMode:"x"},shape:{type:"nmrintegral",strokeColor:"#AF002A",fillColor:"transparent",strokeWidth:2,locked:!1,movable:!0,resizable:!0,selectable:!0,selectOnMouseDown:!0,handles:!0,labelEditable:!0,horizontal:!0,forcedCoords:{y:function(t){return 20+5*t.serie.getIndex()+"px"}},bindable:!0,axis:"x",labels:[{text:"Something",color:"red"}],attributes:{"data-bindable":function(){return Math.random()},id:function(){return Math.random()}},onCreatedShape:function(e){e.addAttribute("id",Math.random()),t.integralCreated(e)},onBeforeNewShape:function(t,e){e.target.classList.contains("bindable")>0&&this.graph.prevent(!0)},highlightOnMouseOver:!0}},mouseActions:[{plugin:"zoom",shift:!1,ctrl:!1},{plugin:"shape",shift:!0,ctrl:!1},{plugin:"zoom",shift:!1,type:"mousewheel",options:{baseline:0,direction:"y"}},{shift:!0,type:"mousewheel",callback:function(e){var i=e/300;t.heightIntegral1+=i,t.ratio=t.heightIntegral1/t.integrals[0].sum,t.recalculateIntegrals(),t.redrawIntegrals()}},{plugin:"zoom",shift:!1,type:"dblclick",options:{mode:"total"}}],onBeforeNewShape:function(){return!this.selectedSerie&&this.series.length>1?!1:void 0}}),this.graphs.setHeight(300),this.graphs.on("shapeRemoved",function(e){"nmrintegral"==e.getType()&&t.integralRemoved(e)}),this.graphs.on("shapeChanged",function(e){"nmrintegral"==e.getType()&&t.integralChanged(e)}),this.graphs.on("shapeLabelChanged",function(e){"nmrintegral"==e.getType()&&t.integralValueChanged(e)}),this.graphs.draw()},o}),a("jquery",function(){return t}),a("jsgraph",function(){return e}),a("jcampconverter",function(){return i}),a("eventEmitter",function(){return n}),s("nmr")});
//# sourceMappingURL=jsnmr.min.js.map