/*! jsNMR 0.0.3 | (c) 2014 Norman Pellet | http://github.com/NPellet/jsNMR/copyright.txt */
define("src/shape.1dnmr",["jquery","jsgraph"],function(t,e){"use strict";function i(t,e){this.options=e||2}var s=5,n=e.getConstructor("graph.shape.line");return t.extend(i.prototype,n.prototype,{createDom:function(){this._createHandles(2,"rect",{transform:"translate(-3 -3)",width:6,height:6,stroke:"black",fill:"white",cursor:"nwse-resize"}),this._dom=document.createElementNS(this.graph.ns,"line"),this.maxLines=64,this.nbLines=0,this.maxLines=0,this.lines=new Array(this.maxLines);for(var t=this.maxLines-1;t>=0;t--)this.lines[t]=document.createElementNS(this.graph.ns,"line"),this.group.appendChild(this.lines[t]),this.lines[t].setAttribute("stroke","green");var e,i=0,s=0,n=0,r=this.graph.series[0].data[0];for(e=0;e<r.length;e+=2)Math.abs(r[e+1])>n&&(n=Math.abs(r[e+1]));for(e=0;e<r.length;e+=2)i+=r[e+1]/n;for(e=0;e<r.length;e+=2)s+=Math.pow(i-r[e+1]/n,2);s=Math.sqrt(n)*Math.sqrt(2*s/r.length),this.noiseLevel=3*s,this._dom.element=this},redrawImpl:function(){this.setHandles(),this.redrawLines(s)},redrawLines:function(t){if(0!=this.maxLines){for(var e=this.findxs(),i=e.length-1;i>=0;i--){var s=this._getPosition({x:10}),n=this._getPosition({x:e[i][0]});this.lines[i]&&n.x&&this.currentPos2y&&this.currentPos1y&&i<this.maxLines&&(this.lines[i].setAttribute("stroke","green"),this.lines[i].setAttribute("x1",n.x),this.lines[i].setAttribute("x2",n.x),this.lines[i].setAttribute("y1",n.y),this.lines[i].setAttribute("y2",s.y),this.lines[i].setAttribute("on",!0))}for(var i=e.length;i<this.nbLines;i++)this.lines[i]&&(this.lines[i].setAttribute("y1",parseFloat(this.lines[i].getAttribute("y2"))),this.lines[i].setAttribute("x1",-1e6),this.lines[i].setAttribute("x2",-1e6),this.lines[i].setAttribute("on",!1));this.nbLines=e.length}},highLigthLinesY:function(t){for(var e=this.lines.length-1;e>=0;e--)"true"==this.lines[e].getAttribute("on")&&this.lines[e].setAttribute("y1",parseFloat(this.lines[e].getAttribute("y1"))-t)},findxs:function(){var t,e,i=this.serie.searchClosestValue(this.getFromData("pos").x),s=this.serie.searchClosestValue(this.getFromData("pos2").x),n=[],r=[];if(!i||!s)return!1;for(var a=i.dataIndex;a<=s.dataIndex;a++)for(t=a==i.dataIndex?i.xBeforeIndexArr:0,e=a==s.dataIndex?s.xBeforeIndexArr:this.serie.data[a].length,A=0,u=t;e>=u;u+=2)n.push(this.serie.data[a][u+0]),r.push(this.serie.data[a][u+1]);for(var a=r.length-1;a>=0;a--)Math.abs(r[a])<this.noiseLevel&&(r[a]=0);for(var o=n[1]-n[0],h=[],p=[],l=[],g=[],u=2;u<n.length-2;u++)p.push(1/35*(-3*r[u-2]+12*r[u-1]+17*r[u]+12*r[u+1]-3*r[u+2])),h.push(n[u]),l.push(1/(12*o)*(r[u-2]-8*r[u-1]+8*r[u+1]-r[u+2])),g.push(1/(7*Math.abs(2*o))*(2*r[u-2]-r[u-1]-2*r[u]-r[u+1]+2*r[u+2]));for(var d=[],c=[],f=[],b=[],a=1;a<p.length-1;a++){if(p[a]>p[a-1]&&p[a]>p[a+1]&&d.push(h[a]),l[a]<l[a-1]&&l[a]<l[a+1]&&c.push(h[a]),l[a]>l[a-1]&&l[a]>l[a+1])try{f.push([h[a],c.pop()])}catch(m){console.log("Error I don't know why")}g[a]<g[a-1]&&g[a]<g[a+1]&&b.push([h[a],p[a]])}for(var v=new Array,u=0;u<b.length;u++){for(var S=b[u],x=S[0],y=new Array,A=0;A<f.length;A++){var a=f[A];x>a[0]&&x<a[1]&&y.push(a)}if(y.length>0&&1==y.length){var G=y[0],w=G[1]-G[0],j=S[1],B=p;B.sort(function(t,e){return t-e}),w>2*o&&j>1e-4*B[0]&&v.push([x,w,j])}}return v}}),i}),define("src/assignment",["jquery"],function(t){"use strict";var e="http://www.w3.org/2000/svg",i=function(i){var s=this;this.options=i,this.bindingPairs=[];var n,r,a=!1,o=!1,h=!1,p={},l=[],g=[],u=function(e,o,h){if(P(),o.shiftKey){for(var p in i.graphs)i.graphs[p].lockShapes();a=!0,s[h]=e,o.preventDefault(),o.stopPropagation()}var l=e.getBBox(),g=t(e).position(),u=g.left+l.width/2,f=g.top+l.height/2;if(n.setAttribute("display","block"),n.setAttribute("x1",u),n.setAttribute("x2",u),n.setAttribute("y1",f),n.setAttribute("y2",f),r=d(h),i[d(h)].targettable){var b=c(d(h));b.each(function(){this.jsGraphIsShape?this.jsGraphIsShape.highlight(i[d(h)].targettable,"binding"):(y(i[d(h)].targettable,t(this)),t(this).attr(i[d(h)].targettable))})}},d=function(t){return"jsGraphShape"==t?"targetB":"jsGraphShape"},c=function(e){return t(i[e].dom).find(i[e].bindableFilter)},f=function(e,o,h){if(P(),r&&i[r].targettable){var p=c(r);p.each(function(){this.jsGraphIsShape?this.jsGraphIsShape.unHighlight("binding"):A(i[r].targettable,t(this))})}if(r=!1,a&&!h)return n.setAttribute("display","none"),void(a=!1);if(a){var l=o.target;n.setAttribute("display","none"),!t(l).is(i[h].bindableFilter)&&!t(l).get(0).classList.contains(i[h].bindableFilterClass)>-1?a=!1:(s[h]=o.target,a=!1,B());for(var g in i.graphs)i.graphs[g].unlockShapes()}},b=function(t){P(),a&&(n.setAttribute("x2",t.clientX+window.scrollX),n.setAttribute("y2",t.clientY+window.scrollY))},m=function(e,s){P();var n=[e];i[s].highlighted&&(n=x(s,e),S(s,n));for(var r=[],a=0,o=n.length;o>a;a++)G(w,n[a],function(e){r=r.concat(t.makeArray(x(d(s),e[d(s)])))});r=t(r),i[d(s)].highlighted&&S(d(s),r)},v=function(e,s,n){P();for(var r=x(s,e),a=[],o=0;o<r.length;o++)G(j,r[o],function(e){a=a.concat(t.makeArray(x(d(s),e[d(s)])))});p.jsGraphShape.map(function(t){this.jsGraphIsShape.unHighlight("assignmentHighlighted")}),A(i.targetB.highlighted,p.targetB)},S=function(t,e){var s=i[t].highlighted;e[0]&&e[0].jsGraphIsShape?e.map(function(t){this.jsGraphIsShape.highlight(s,"assignmentHighlighted")}):(y(s,e),e.attr(s)),p[t]=e},x=function(e,s){var n=s.getAttribute(i[e].attributeEquivalents);return t(i[e].dom).find("["+i[e].attributeEquivalents+'="'+n+'"]')},y=function(e,i){for(var s in e)for(var n=0,r=i.length;r>n;n++)t(i[n]).data("backup-"+s)||t(i[n]).data("backup-"+s,t(i[n]).attr(s))},A=function(e,i){for(var s in e)for(var n=0,r=i.length;r>n;n++)t(i[n]).attr(s,t(i[n]).data("backup-"+s))},G=function(t,e,i){for(var n=0,r=s.bindingPairs.length;r>n;n++)(s.bindingPairs[n].jsGraphShape==e||s.bindingPairs[n].targetB==e)&&(t(s.bindingPairs[n]),i&&i(s.bindingPairs[n]))},w=function(s){var n,r=t(s.jsGraphShape).offset(),a=t(s.targetB).offset(),o=t(s.jsGraphShape)[0].getBBox(),h=t(s.targetB)[0].getBBox(),p=i.domGlobal.offset();l.length>0?(n=l.pop(),n.setAttribute("display","block")):n=document.createElementNS(e,"line"),n.setAttribute("stroke","black"),n.setAttribute("x1",r.left-p.left+o.width/2),n.setAttribute("y1",r.top-p.top+o.height/2),n.setAttribute("x2",a.left-p.left+h.width/2),n.setAttribute("y2",a.top-p.top+h.height/2),s.line=n,g.push(n),C.appendChild(n)},j=function(t){t.line=!1,g.map(function(t){t.setAttribute("display","none")}),l=l.concat(g),g=[]},B=function(){var t;return(t=L(s.jsGraphShape,s.targetB))?(k(t),j(t),!1):(v(s.jsGraphShape,"jsGraphShape",!0),s.bindingPairs.push({jsGraphShape:s.jsGraphShape,targetB:s.targetB}),s.jsGraphShape.jsGraphIsShape.setStrokeDasharray("5,5"),s.jsGraphShape.jsGraphIsShape.applyStyle(),o=null,h=null,void console.log(s.getAssignment()))},k=function(t){s.bindingPairs.splice(s.bindingPairs.indexOf(t),1)},L=function(t,e){return s.bindingPairs.map(function(i){return i.jsGraphShape==t||i.targetB==e?i:void 0}),!1},P=function(){for(var e=0,n=s.bindingPairs.length;n>e;e++)t(i.jsGraphShape.dom).get(0).contains(s.bindingPairs[e].jsGraphShape)&&t(i.targetB.dom).get(0).contains(s.bindingPairs[e].targetB)||(s.bindingPairs[e]=!1)},D=function(){i.jsGraphShape.dom.on("mousedown",i.jsGraphShape.bindableFilter,function(t){u(this,t,"jsGraphShape")}),i.jsGraphShape.dom.on("mouseover",i.jsGraphShape.bindableFilter,function(t){m(this,"jsGraphShape")}),i.jsGraphShape.dom.on("mouseout",i.jsGraphShape.bindableFilter,function(t){v(this,"jsGraphShape")}),i.targetB.dom.on("mousedown",i.targetB.bindableFilter,function(t){u(this,t,"targetB")}),i.targetB.dom.on("mouseover",i.targetB.bindableFilter,function(t){m(this,"targetB")}),i.targetB.dom.on("mouseout",i.targetB.bindableFilter,function(t){v(this,"targetB")}),i.jsGraphShape.dom.on("mouseup",function(t){f(this,t,"jsGraphShape")}),i.targetB.dom.on("mouseup",function(t){f(this,t,"targetB")}),i.domGlobal.on("mouseup",function(t){f(this,t,!1)}),i.domGlobal.on("mousemove",function(t){b(t)})},C=document.createElementNS(e,"svg");C.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),C.setAttribute("xmlns",e),C.setAttribute("style","position: absolute"),C.setAttribute("width",i.domGlobal.width()),C.setAttribute("height",i.domGlobal.height()),C.setAttribute("pointer-events","none"),n=document.createElementNS(e,"line"),n.setAttribute("stroke","black"),C.appendChild(n),i.domGlobal.prepend(C),D()};return i.prototype.getAssignment=function(){var t=this;return this.bindingPairs.map(function(e){if(e){var i=e.jsGraphShape.getAttribute(t.options.jsGraphShape.attributeEquivalents),s=e.targetB.getAttribute(t.options.targetB.attributeEquivalents);return[i,s]}})},i.prototype.findElement=function(e,i){return t(this.options[e].dom).find("["+this.options[e].attributeEquivalents+'="'+i+'"]')},i.prototype.setAssignment=function(t){var e=this;e.bindingPairs=[],t.forEach(function(t){e.bindingPairs.push({jsGraphShape:e.findElement("jsGraphShape",t[0]),targetB:e.findElement("targetB",t[1])})})},i}),define("src/nmr.js",["jsgraph","./shape.1dnmr","./assignment","jcampconverter"],function(t,e,i,s){function n(t,e,i){var n=[];for(var r in e)n.push($.get(e[r]).then(function(t){return s.convert(t,{keepSpectra:!0})}));t.divLoading||(t.divLoading=$("<div />").css({width:t.getDom().width(),height:t.getDom().height(),position:"absolute",backgroundColor:"rgba(200, 200, 200, 0.5)",textAlign:"center",lineHeight:t.getDom().height()+"px",fontSize:"2em",border:"1px solid #c0c0c0"}).html("Loading..."),t.getDom().prepend(t.divLoading)),t.loading=t.loading||0,t.loading++,$.when.apply($,n).then(function(){var s=0;for(r in e)e[r]=arguments[s],s++;t.loading--,0==t.loading&&(t.divLoading.remove(),t.divLoading=!1),t.series.push(e),t.loaded(e,i,"a"+Math.random())})}function r(t,e,i){var s=d.length;1==s&&(l=150/d[0].sum,g=d[0].sum);for(var n=0;s>n;n++){d[n].ratio=l;var r=Math.round(d[n].sum/g*100)/100;isNaN(r)||d[n].setLabelText(r),d[n].updateLabels()}}function a(t,e,i){c.push(i),t.graphs.selectedSerie?i.setSerie(t.graphs.selectedSerie):i.setSerie(t.graphs.getSerie(0)),i.integral=i,d.push(i)}function o(t,e,i){var s;(s=t.graphs[e].getSerie(i))&&s.kill(),t.graphs[e].redraw(),t.graphs[e].drawSeries()}function h(t){t.options.dom.append("<div />"),t.makeGraphs1D()}function p(s){this.options=$.extend(!0,{},u,s),this.series=[],t.registerConstructor("graph.shape.1dnmr",e);switch(this.graphs={x:null},this.integrals={x:[]},h(this),this.options.mode){case"2d":break;case"1d":this.legend=this.graphs.makeLegend({frame:!0,frameWidth:2,frameColor:"grey",movable:!0,backgroundColor:"white"}),this.legend.setPosition({x:"300px",y:"40px"},"right")}this.options.assignment&&(this.assignement=new i($.extend(this.options.assignment,{graphs:this.graphs,domGraphs:this.options.dom})))}var l,g,u={mode:"1d",molecule:!1,urls:{}},d=[],c=[],f={urls:{}};return p.prototype.load=function(t){var t=$.extend(!0,{},f,t),e={};switch(this.options.mode){case"1d":t.urls.oneD=t.url||t.urls.oneD||t.urls.x,e.x=t.urls.oneD}n(this,e,t)},p.prototype.isSymmetric=function(){return this.options.symmetric||!1},p.prototype.getMode=function(){return this.options.mode},p.prototype.getDom=function(){return this.options.dom},p.prototype.getGraph2D=function(){return this.graphs._2d},p.prototype.getGraphX=function(){return this.graphs.x},p.prototype.getGraphY=function(){return this.graphs.y},p.prototype.resize1DTo=function(t,e){this.graphs.resize(t,e),this.graphs.drawSeries()},p.prototype.removeSerieX=function(t){o(this,"x",t)},p.prototype.setSerieX=function(t,e,i){this.graphs.getSerie(t)&&(this.graphs.getSerie(t).kill(),this.graphs.removeShapes(),this.integralBasis=!1);var s=this.graphs.newSerie(t,$.extend({useSlots:!0},i)).setLabel("My serie").autoAxis().setData(e).XIsMonotoneous();i.lineColor&&s.setLineColor(i.lineColor),i.lineWidth&&s.setLineWidth(i.lineWidth),i.setLineStyle&&s.setLineStyle(i.lineStyle),s.XIsMonotoneous(),s.getXAxis().setAxisDataSpacingMax(0),s.getXAxis().setAxisDataSpacingMin(0),s.getYAxis().setDisplay(!1).primaryGridOff(!1).secondaryGridOff(!1),s.getXAxis().flip(!0).setLabel("ppm").primaryGridOff(!1).secondaryGridOff(!1).setTickPosition("outside"),this.graphs.autoscaleAxes(),this.graphs.draw()},p.prototype.loaded=function(t,e,i){switch(this.getMode()){case"1d":this.setSerieX(i,t.x.spectra[0].data[0],{label:"SomeLabel"})}},p.prototype.makeGraphs1D=function(){var e=this;this.graphs=new t(this.getDom().children().get(0),{close:{left:!1,top:!1,right:!1},paddingBottom:0,paddingTop:0,paddingLeft:0,paddingRight:0,plugins:{zoom:{zoomMode:"x"},shape:{type:"nmrintegral",strokeColor:"#AF002A",fillColor:"transparent",strokeWidth:2,locked:!1,movable:!0,resizable:!0,selectable:!0,selectOnMouseDown:!0,handles:!0,labelEditable:!0,horizontal:!0,forcedCoords:{y:function(t){return 20+5*t.serie.getIndex()+"px"}},bindable:!0,axis:"x",labels:[{text:"Something",color:"red"}],attributes:{"data-bindable":function(){return 1}},onCreatedShape:function(t){t.setSerie(e.graphs.getSerie(0)),a(e,"x",t)},highlightOnMouseOver:!0}},dblclick:{type:"plugin",plugin:"zoom",options:{mode:"total"}},wheel:{type:"plugin",plugin:"zoom",options:{direction:"y",baseline:0}},pluginAction:{zoom:{shift:!1,ctrl:!1},shape:{shift:!0,ctrl:!1}},onBeforeNewShape:function(){return!this.selectedSerie&&this.series.length>1?!1:void 0}}),this.graphs.setHeight(300),this.graphs.on("shapeChanged",function(t){"nmrintegral"==t.getType()&&r(e)}),this.graphs.on("shapeLabelChanged",function(t){if("nmrintegral"==t.getType()){var i=parseFloat(t.getLabelText(0));g=t.sum/i,r(e)}}),this.graphs.redraw(),this.graphs.drawSeries()},p});
//# sourceMappingURL=jsnmr.min.js.map