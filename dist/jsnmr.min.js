/*! jsNMR 0.0.2 | (c) 2014 Norman Pellet | http://github.com/NPellet/jsNMR/copyright.txt */
define("src/shape.1dnmr",["jquery","jsgraph"],function(t,e){"use strict";function i(t,e){this.options=e||2}var r=5,n=e.getConstructor("graph.shape.line");return t.extend(i.prototype,n.prototype,{createDom:function(){this._createHandles(2,"rect",{transform:"translate(-3 -3)",width:6,height:6,stroke:"black",fill:"white",cursor:"nwse-resize"}),this._dom=document.createElementNS(this.graph.ns,"line"),this.maxLines=64,this.nbLines=0,this.maxLines=0,this.lines=new Array(this.maxLines);for(var t=this.maxLines-1;t>=0;t--)this.lines[t]=document.createElementNS(this.graph.ns,"line"),this.group.appendChild(this.lines[t]),this.lines[t].setAttribute("stroke","green");var e,i=0,r=0,n=0,s=this.graph.series[0].data[0];for(e=0;e<s.length;e+=2)Math.abs(s[e+1])>n&&(n=Math.abs(s[e+1]));for(e=0;e<s.length;e+=2)i+=s[e+1]/n;for(e=0;e<s.length;e+=2)r+=Math.pow(i-s[e+1]/n,2);r=Math.sqrt(n)*Math.sqrt(2*r/s.length),this.noiseLevel=3*r,this._dom.element=this},redrawImpl:function(){this.setHandles(),this.redrawLines(r)},redrawLines:function(t){if(0!=this.maxLines){for(var e=this.findxs(),i=e.length-1;i>=0;i--){var r=this._getPosition({x:10}),n=this._getPosition({x:e[i][0]});this.lines[i]&&n.x&&this.currentPos2y&&this.currentPos1y&&i<this.maxLines&&(this.lines[i].setAttribute("stroke","green"),this.lines[i].setAttribute("x1",n.x),this.lines[i].setAttribute("x2",n.x),this.lines[i].setAttribute("y1",n.y),this.lines[i].setAttribute("y2",r.y),this.lines[i].setAttribute("on",!0))}for(var i=e.length;i<this.nbLines;i++)this.lines[i]&&(this.lines[i].setAttribute("y1",parseFloat(this.lines[i].getAttribute("y2"))),this.lines[i].setAttribute("x1",-1e6),this.lines[i].setAttribute("x2",-1e6),this.lines[i].setAttribute("on",!1));this.nbLines=e.length}},highLigthLinesY:function(t){for(var e=this.lines.length-1;e>=0;e--)"true"==this.lines[e].getAttribute("on")&&this.lines[e].setAttribute("y1",parseFloat(this.lines[e].getAttribute("y1"))-t)},findxs:function(){var t,e,i=this.serie.searchClosestValue(this.getFromData("pos").x),r=this.serie.searchClosestValue(this.getFromData("pos2").x),n=[],s=[];if(!i||!r)return!1;for(var a=i.dataIndex;a<=r.dataIndex;a++)for(t=a==i.dataIndex?i.xBeforeIndexArr:0,e=a==r.dataIndex?r.xBeforeIndexArr:this.serie.data[a].length,A=0,p=t;e>=p;p+=2)n.push(this.serie.data[a][p+0]),s.push(this.serie.data[a][p+1]);for(var a=s.length-1;a>=0;a--)Math.abs(s[a])<this.noiseLevel&&(s[a]=0);for(var o=n[1]-n[0],h=[],l=[],u=[],f=[],p=2;p<n.length-2;p++)l.push(1/35*(-3*s[p-2]+12*s[p-1]+17*s[p]+12*s[p+1]-3*s[p+2])),h.push(n[p]),u.push(1/(12*o)*(s[p-2]-8*s[p-1]+8*s[p+1]-s[p+2])),f.push(1/(7*Math.abs(2*o))*(2*s[p-2]-s[p-1]-2*s[p]-s[p+1]+2*s[p+2]));for(var g=[],c=[],d=[],m=[],a=1;a<l.length-1;a++){if(l[a]>l[a-1]&&l[a]>l[a+1]&&g.push(h[a]),u[a]<u[a-1]&&u[a]<u[a+1]&&c.push(h[a]),u[a]>u[a-1]&&u[a]>u[a+1])try{d.push([h[a],c.pop()])}catch(b){console.log("Error I don't know why")}f[a]<f[a-1]&&f[a]<f[a+1]&&m.push([h[a],l[a]])}for(var v=new Array,p=0;p<m.length;p++){for(var y=m[p],S=y[0],x=new Array,A=0;A<d.length;A++){var a=d[A];S>a[0]&&S<a[1]&&x.push(a)}if(x.length>0&&1==x.length){var w=x[0],G=w[1]-w[0],D=y[1],X=l;X.sort(function(t,e){return t-e}),G>2*o&&D>1e-4*X[0]&&v.push([S,G,D])}}return v}}),i}),function(t,e){"object"==typeof module&&"object"==typeof module.exports?module.exports=e(t):e(t)}("undefined"!=typeof window?window:this,function(t){"use strict";var e="http://www.w3.org/2000/svg",i=function(i){var r=this;this.options=i,this.bindingPairs=[];var n,s,a=!1,o=!1,h=!1,l={},u=[],f=[],p=function(t,e,o){if(k(),e.shiftKey){for(var h in i.graphs)i.graphs[h].lockShapes();a=!0,r[o]=t,e.preventDefault(),e.stopPropagation()}var l=t.getBBox(),u=$(t).position(),f=u.left+l.width/2,p=u.top+l.height/2;if(n.setAttribute("display","block"),n.setAttribute("x1",f),n.setAttribute("x2",f),n.setAttribute("y1",p),n.setAttribute("y2",p),s=g(o),i[g(o)].targettable){var d=c(g(o));d.each(function(){this.jsGraphIsShape?this.jsGraphIsShape.highlight(i[g(o)].targettable,"binding"):(x(i[g(o)].targettable,$(this)),$(this).attr(i[g(o)].targettable))})}},g=function(t){return"jsGraphShape"==t?"targetB":"jsGraphShape"},c=function(t){return $(i[t].dom).find(i[t].bindableFilter)},d=function(t,e,o){if(k(),s&&i[s].targettable){var h=c(s);h.each(function(){this.jsGraphIsShape?this.jsGraphIsShape.unHighlight("binding"):A(i[s].targettable,$(this))})}if(s=!1,a&&!o)return n.setAttribute("display","none"),void(a=!1);if(a){var l=e.target;n.setAttribute("display","none"),!$(l).is(i[o].bindableFilter)&&!$(l).get(0).classList.contains(i[o].bindableFilterClass)>-1?a=!1:(r[o]=e.target,a=!1,X());for(var u in i.graphs)i.graphs[u].unlockShapes()}},m=function(e){k(),a&&(n.setAttribute("x2",e.clientX+t.scrollX),n.setAttribute("y2",e.clientY+t.scrollY))},b=function(t,e){k();var r=[t];i[e].highlighted&&(r=S(e,t),y(e,r));for(var n=[],s=0,a=r.length;a>s;s++)w(G,r[s],function(t){n=n.concat($.makeArray(S(g(e),t[g(e)])))});n=$(n),i[g(e)].highlighted&&y(g(e),n)},v=function(t,e,r){k();for(var n=S(e,t),s=[],a=0;a<n.length;a++)w(D,n[a],function(t){s=s.concat($.makeArray(S(g(e),t[g(e)])))});l.jsGraphShape.map(function(t){this.jsGraphIsShape.unHighlight("assignmentHighlighted")}),A(i.targetB.highlighted,l.targetB)},y=function(t,e){var r=i[t].highlighted;e[0]&&e[0].jsGraphIsShape?e.map(function(t){this.jsGraphIsShape.highlight(r,"assignmentHighlighted")}):(x(r,e),e.attr(r)),l[t]=e},S=function(t,e){var r=e.getAttribute(i[t].attributeEquivalents);return $(i[t].dom).find("["+i[t].attributeEquivalents+'="'+r+'"]')},x=function(t,e){for(var i in t)for(var r=0,n=e.length;n>r;r++)$(e[r]).data("backup-"+i)||$(e[r]).data("backup-"+i,$(e[r]).attr(i))},A=function(t,e){for(var i in t)for(var r=0,n=e.length;n>r;r++)$(e[r]).attr(i,$(e[r]).data("backup-"+i))},w=function(t,e,i){for(var n=0,s=r.bindingPairs.length;s>n;n++)(r.bindingPairs[n].jsGraphShape==e||r.bindingPairs[n].targetB==e)&&(t(r.bindingPairs[n]),i&&i(r.bindingPairs[n]))},G=function(t){var r,n=$(t.jsGraphShape).offset(),s=$(t.targetB).offset(),a=$(t.jsGraphShape)[0].getBBox(),o=$(t.targetB)[0].getBBox(),h=i.domGlobal.offset();u.length>0?(r=u.pop(),r.setAttribute("display","block")):r=document.createElementNS(e,"line"),r.setAttribute("stroke","black"),r.setAttribute("x1",n.left-h.left+a.width/2),r.setAttribute("y1",n.top-h.top+a.height/2),r.setAttribute("x2",s.left-h.left+o.width/2),r.setAttribute("y2",s.top-h.top+o.height/2),t.line=r,f.push(r),j.appendChild(r)},D=function(t){t.line=!1,f.map(function(t){t.setAttribute("display","none")}),u=u.concat(f),f=[]},X=function(){var t;return(t=F(r.jsGraphShape,r.targetB))?(Y(t),D(t),!1):(v(r.jsGraphShape,"jsGraphShape",!0),r.bindingPairs.push({jsGraphShape:r.jsGraphShape,targetB:r.targetB}),r.jsGraphShape.jsGraphIsShape.setStrokeDasharray("5,5"),r.jsGraphShape.jsGraphIsShape.applyStyle(),o=null,h=null,void console.log(r.getAssignment()))},Y=function(t){r.bindingPairs.splice(r.bindingPairs.indexOf(t),1)},F=function(t,e){return r.bindingPairs.map(function(i){return i.jsGraphShape==t||i.targetB==e?i:void 0}),!1},k=function(){for(var t=0,e=r.bindingPairs.length;e>t;t++)$(i.jsGraphShape.dom).get(0).contains(r.bindingPairs[t].jsGraphShape)&&$(i.targetB.dom).get(0).contains(r.bindingPairs[t].targetB)||(r.bindingPairs[t]=!1)},M=function(){i.jsGraphShape.dom.on("mousedown",i.jsGraphShape.bindableFilter,function(t){p(this,t,"jsGraphShape")}),i.jsGraphShape.dom.on("mouseover",i.jsGraphShape.bindableFilter,function(t){b(this,"jsGraphShape")}),i.jsGraphShape.dom.on("mouseout",i.jsGraphShape.bindableFilter,function(t){v(this,"jsGraphShape")}),i.targetB.dom.on("mousedown",i.targetB.bindableFilter,function(t){p(this,t,"targetB")}),i.targetB.dom.on("mouseover",i.targetB.bindableFilter,function(t){b(this,"targetB")}),i.targetB.dom.on("mouseout",i.targetB.bindableFilter,function(t){v(this,"targetB")}),i.jsGraphShape.dom.on("mouseup",function(t){d(this,t,"jsGraphShape")}),i.targetB.dom.on("mouseup",function(t){d(this,t,"targetB")}),i.domGlobal.on("mouseup",function(t){d(this,t,!1)}),i.domGlobal.on("mousemove",function(t){m(t)})},j=document.createElementNS(e,"svg");j.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),j.setAttribute("xmlns",e),j.setAttribute("style","position: absolute"),j.setAttribute("width",i.domGlobal.width()),j.setAttribute("height",i.domGlobal.height()),j.setAttribute("pointer-events","none"),n=document.createElementNS(e,"line"),n.setAttribute("stroke","black"),j.appendChild(n),i.domGlobal.prepend(j),M()};i.prototype.getAssignment=function(){var t=this;return this.bindingPairs.map(function(e){if(e){var i=e.jsGraphShape.getAttribute(t.options.jsGraphShape.attributeEquivalents),r=e.targetB.getAttribute(t.options.targetB.attributeEquivalents);return[i,r]}})},i.prototype.findElement=function(t,e){return $(this.options[t].dom).find("["+this.options[t].attributeEquivalents+'="'+e+'"]')},i.prototype.setAssignment=function(t){var e=this;e.bindingPairs=[],t.forEach(function(t){e.bindingPairs.push({jsGraphShape:e.findElement("jsGraphShape",t[0]),targetB:e.findElement("targetB",t[1])})})};var r=function(t){return i};if("function"==typeof define&&define.amd)define("src/assignment",["jquery"],function(t){return r(t)});else if(t){if(!t.jQuery)throw"jQuery has not been loaded. Abort assignment initialization.";t.Assignment=r(t.jQuery)}});var SD={create:function(t){return new ESD(t)}},HeteroNuclearPeakOptimizer={toleranceX:.025,toleranceY:.5,clean:function(t,e){var i,r=Number.NEGATIVE_INFINITY;for(i=t.length-1;i>=0;i--)Math.abs(t[i].z)>r&&(r=Math.abs(t[i].z));for(r*=e,i=t.length-1;i>=0;i--)Math.abs(t[i].z)<r&&t.splice(i,1);return t}},HomoNuclearPeakOptimizer={diagonalError:.05,tolerance:.05,DEBUG:!1,enhanceSymmetry:function(t){var e=this.initializeProperties(t),i=t;this.DEBUG&&console.log("Before optimization size: "+i.size());var r,n,s,a;for(r=i.length-1;r>=0;r--)a=i[r],a.peaks.length>1&&e[r][1]++,1==e[r][0]&&(s=this.exist(i,e,a,-1,!0),s>=0&&(e[r][1]+=2,e[s][1]+=2));for(r=i.length-1;r>=0;r--)a=i[r],0==e[r][0]&&(n=this.checkCrossPeaks(i,e,a,!0),e[r][1]+=n);var o=0;for(r=i.length-1;r>=0;r--)0!=e[r][0]&&e[r][1]>2&&(o++,o+=this.completeMissingIfNeeded(i,e,i[r],e[r])),e[r][1]>=2&&0==e[r][0]&&o++;this.DEBUG&&console.log("After optimization size: "+o);var h=new Array(o);for(o--,r=i.length-1;r>=0;r--)0!=e[r][0]&&e[r][1]>2||0==e[r][0]&&e[r][1]>1?h[o--]=i[r]:console.log("Removed "+r+" "+i[r].peaks.length);return h},completeMissingIfNeeded:function(t,e,i,r){var n=this.exist(t,e,i,-r[0],!0),s=0;if(0>n){var a={nucleusX:i.nucleusX,nucleusY:i.nucleusY};a.resolutionX=i.resolutionX,a.resolutionY=i.resolutionY,a.shiftX=i.shiftY,a.shiftY=i.shiftX,a.peaks=[{x:i.shiftY,y:i.shiftX,z:1}],t.push(a);var o=[-r[0],r[1]];e.push(o),s++}var h,l=0,u=!1,f=!1;for(l=t.length-1;l>=0;l--)h=t[l],0==e[l][0]&&(Math.abs(h.shiftX-i.shiftX)<this.diagonalError&&(u=!0),Math.abs(h.shiftY-i.shiftY)<this.diagonalError&&(f=!0));if(0==u){var a={nucleusX:i.nucleusX,nucleusY:i.nucleusY};a.resolutionX=i.resolutionX,a.resolutionY=i.resolutionY,a.shiftX=i.shiftX,a.shiftY=i.shiftX,a.peaks=[{x:i.shiftX,y:i.shiftX,z:1}],t.push(a);var o=[0,r[1]];e.push(o),s++}if(0==f){var a={nucleusX:i.nucleusX,nucleusY:i.nucleusY};a.resolutionX=i.resolutionX,a.resolutionY=i.resolutionY,a.shiftX=i.shiftY,a.shiftY=i.shiftY,a.peaks=[{x:i.shiftY,y:i.shiftY,z:1}],t.push(a);var o=[0,r[1]];e.push(o),s++}return s},checkCrossPeaks:function(t,e,i,r){var n,s,a=0,s=0,o=4*i.shiftX,h=[],l=[];for(s=t.length-1;s>=0;s--)n=t[s],0!=e[s][0]&&(Math.abs(n.shiftX-i.shiftX)<this.diagonalError?(a++,r&&e[s][1]++,h.push(s),o+=n.shiftX):Math.abs(n.shiftY-i.shiftY)<this.diagonalError&&(a++,r&&e[s][1]++,l.push(s),o+=n.shiftY));if(o/=h.length+l.length+4,h.length>0)for(var s=h.length-1;s>=0;s--)t[h[s]].shiftX=o;if(l.length>0)for(var s=l.length-1;s>=0;s--)t[l[s]].shiftY=o;return i.shiftX=o,i.shiftY=o,a},exist:function(t,e,i,r,n){for(var s=t.length-1;s>=0;s--)if(e[s][0]==r&&this.distanceTo(i,t[s],n)<this.tolerance){if(n){var a=i.shiftX,o=t[s].shiftX;t[s].shiftY=a,i.shiftY=o}else{var a=(t[s].shiftX+i.shiftX)/2,o=(t[s].shiftY+i.shiftY)/2;t[s].shiftX=a,t[s].shiftY=o,i.shiftX=a,i.shiftY=o}return s}return-1},initializeProperties:function(t){for(var e=new Array(t.length),i=t.length-1;i>=0;i--)if(e[i]=[0,0],Math.abs(t[i].shiftX-t[i].shiftY)<=this.diagonalError){e[i][1]=1;var r=(2*t[i].shiftX+t[i].shiftY)/3;t[i].shiftX=r,t[i].shiftY=r}else t[i].shiftX-t[i].shiftY>0?e[i][0]=1:e[i][0]=-1;return e},distanceTo:function(t,e,i){return i?Math.sqrt(Math.pow(t.shiftX-e.shiftY,2)+Math.pow(t.shiftY-e.shiftX,2)):Math.sqrt(Math.pow(t.shiftX-e.shiftX,2)+Math.pow(t.shiftY-e.shiftY,2))}},SimpleClustering={fullClusterGenerator:function(t){for(var e=Math.sqrt(2*t.length+.25)-.5,i=[],r=new Array(e),n=e,s=[],a=e-1;a>=0;a--)r[a]=1;for(var a,o=-1,h=[];n>0;){if(0==h.length){for(s=new Array(e),a=e-1;a>=0;a--)s[a]=0;for(i.push(s),o=e-1;0==r[o];o--);}else o=h.splice(0,1);s[o]=1,r[o]=0,n--;var l=new Array(e);for(a=e-1;a>=0;a--){var u=Math.max(o,a),f=Math.min(o,a);l[a]=t[f*(2*e-f-1)/2+u],1==l[a]&&1==r[a]&&0==s[a]&&(h.push(a),s[a]=1)}}return i}},MathUtils={getMinMax:function(t){for(var e=[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],i=t.length-1;i>=0;i--)t[i]<e[0]&&(e[0]=t[i]),t[i]>e[1]&&(e[1]=t[i]);return e}},FFTUtils={ifft2DArray:function(t,e,i){var r=new Array(e*i),n=e/2,s=2*(i-1);FFT.init(n);for(var a={re:new Array(n),im:new Array(n)},o=0;i>o;o++){for(var h=n-1;h>=0;h--)a.re[h]=t[2*h*i+o],a.im[h]=t[(2*h+1)*i+o];FFT.bt(a.re,a.im);for(var h=n-1;h>=0;h--)r[2*h*i+o]=a.re[h],r[(2*h+1)*i+o]=a.im[h]}var l=new Array(n*s);FFT.init(s);for(var u={re:new Array(s),im:new Array(s)},f=s*n,h=0;e>h;h+=2){u.re[0]=r[h*i],u.im[0]=r[(h+1)*i];for(var o=1;i>o;o++)u.re[o]=r[h*i+o],u.im[o]=r[(h+1)*i+o],u.re[s-o]=r[h*i+o],u.im[s-o]=-r[(h+1)*i+o];FFT.bt(u.re,u.im);for(var p=h/2*s,o=s-1;o>=0;o--)l[p+o]=u.re[o]/f}return l},fft2DArray:function(t,e,i){var r=i/2+1,n=2*e,s=new Array(n*r);FFT.init(i);for(var a,o,h,l,u,f={re:new Array(i),im:new Array(i)},p={re:new Array(i),im:new Array(i)},g={re:new Array(i),im:new Array(i)},c=0;e/2>c;c++){a=2*c*i,f.re=t.slice(a,a+i),a=(2*c+1)*i,f.im=t.slice(a,a+i),FFT.fft1d(f.re,f.im),this.reconstructTwoRealFFT(f,p,g),o=4*c*r,h=(4*c+1)*r,l=(4*c+2)*r,u=(4*c+3)*r;for(var d=r-1;d>=0;d--)s[o+d]=p.re[d],s[h+d]=p.im[d],s[l+d]=g.re[d],s[u+d]=g.im[d]}p=null,g=null;var m=new Array(n*r);FFT.init(e);for(var b={re:new Array(e),im:new Array(e)},v=r-1;v>=0;v--){for(var c=e-1;c>=0;c--)b.re[c]=s[2*c*r+v],b.im[c]=s[(2*c+1)*r+v];FFT.fft1d(b.re,b.im);for(var c=e-1;c>=0;c--)m[2*c*r+v]=b.re[c],m[(2*c+1)*r+v]=b.im[c]}return m},reconstructTwoRealFFT:function(t,e,i){var r=t.re.length;e.re[0]=t.re[0],e.im[0]=0,i.re[0]=t.im[0],i.im[0]=0;for(var n,s,a,o,h,l=r/2;l>0;l--)h=r-l,n=.5*(t.re[l]-t.re[h]),s=.5*(t.re[l]+t.re[h]),a=.5*(t.im[l]-t.im[h]),o=.5*(t.im[l]+t.im[h]),e.re[l]=s,e.im[l]=a,e.re[h]=s,e.im[h]=-a,i.re[l]=o,i.im[l]=-n,i.re[h]=o,i.im[h]=n},convolute2DI:function(t,e,i,r){for(var n,s,a=0;i/2>a;a++)for(var o=0;r>o;o++)n=t[2*a*r+o]*e[2*a*r+o]-t[(2*a+1)*r+o]*e[(2*a+1)*r+o],s=t[2*a*r+o]*e[(2*a+1)*r+o]+t[(2*a+1)*r+o]*e[2*a*r+o],t[2*a*r+o]=n,t[(2*a+1)*r+o]=s}},PeakFinders2D={DEBUG:!1,smallFilter:[[0,0,1,2,2,2,1,0,0],[0,1,4,7,7,7,4,1,0],[1,4,5,3,0,3,5,4,1],[2,7,3,-12,-23,-12,3,7,2],[2,7,0,-23,-40,-23,0,7,2],[2,7,3,-12,-23,-12,3,7,2],[1,4,5,3,0,3,5,4,1],[0,1,3,7,7,7,3,1,0],[0,0,1,2,2,2,1,0,0]],getLoGnStdDevNMR:function(t){return t.isHomoNuclear()?1.5:3},_findPeaks2DLoG:function(t,e){0==e&&(e=1),0>e&&(e=-e);for(var i=t.getNbPoints(),r=t.getNbSubSpectra(),n=new Array(i*r),s=t.isHomoNuclear(),a=0;r>a;a++)for(var o=t.getSpectraData(a),h=0;i>h;h++)s?n[a*i+h]=o[2*h+1]>0?o[2*h+1]:0:n[a*i+h]=Math.abs(o[2*h+1]);var l=this.getLoGnStdDevNMR(t);if(s){for(var u=this.convoluteWithLoG(n,r,i),f=this.findPeaks2DLoG(n,u,r,i,l*e),p=this.findPeaks2DMax(n,u,r,i,(l+.5)*e),g=0;g<f.length;g++)p.push(f[g]);return HomoNuclearPeakOptimizer.enhanceSymmetry(this.createSignals2D(p,t,24))}var u=this.convoluteWithLoG(n,r,i),f=this.findPeaks2DLoG(n,u,r,i,l*e);return this.createSignals2D(HeteroNuclearPeakOptimizer.clean(f,.05),t,24)},convoluteWithLoG:function(t,e,i){for(var r=new Array(i*e),n=e*i-1;n>=0;n--)r[n]=t[n];r=FFTUtils.fft2DArray(r,e,i);for(var s=this.smallFilter.length,a=new Array(i*e),n=i*e-1;n>=0;n--)a[n]=0;for(var o,h,l=(s-1)/2,u=0;s>u;u++){o=(u-l+e)%e;for(var f=0;s>f;f++)h=(f-l+i)%i,a[o*i+h]=this.smallFilter[u][f]}a=FFTUtils.fft2DArray(a,e,i);var p=2*e,g=i/2+1;return FFTUtils.convolute2DI(r,a,p,g),FFTUtils.ifft2DArray(r,p,g)},findPeaks2DLoG:function(t,e,i,r,n){for(var s=0,a=r*i-2;a>=0;a--)s+=Math.pow(e[a]-e[a+1],2);s=-Math.sqrt(s),s*=n/i;for(var o=new Array(r*i),a=r*i-1;a>=0;a--)o[a]=0;for(var h=0,a=e.length-1;a>=0;a--)e[a]<s&&(o[a]=1,h++);for(var l=0,u=[];0!=h;){for(l;l<o.length&&0==o[l];l++);if(l==o.length)break;h-=this.extractArea(t,e,o,l,i,r,u,s)}return u.length>0&&this.DEBUG&&console.log("No peak found"),u},findPeaks2DMax:function(t,e,i,r,n){for(var s=0,a=r*i-2;a>=0;a--)s+=Math.pow(e[a]-e[a+1],2);s=-Math.sqrt(s),s*=n/i;for(var o,h,l=[],u=0,a=0;a<e.length;a++)e[a]<s&&(o=Math.floor(a/r),h=a%r,o>0&&i>o+1&&r>h+1&&h>0&&e[a]<e[a+1]&&e[a]<e[a-1]&&(u=(o-1)*r+h,e[a]<e[u-1]&&e[a]<e[u]&&e[a]<e[u+1]&&(u=(o+1)*r+h,e[a]<e[u-1]&&e[a]<e[u]&&e[a]<e[u+1]&&l.push({x:h,y:o,z:t[a]}))));return l},extractArea:function(t,e,i,r,n,s,a,o){var h=Math.floor(r/s),l=r%s,u=[];this.scanBitmask(i,n,s,h,l,u);var f=new Array(u.length),p=new Array(u.length),g=new Array(u.length),c=u.length,d=0,m=0,b=0;if(c>=9){this.DEBUG&&console.log("nValues="+c);for(var v=Number.NEGATIVE_INFINITY,y=-1,S=0;c>S;S++){var x=u.splice(0,1)[0];f[S]=x[0],p[S]=x[1],g[S]=t[x[1]*s+x[0]],d+=f[S]*g[S],m+=p[S]*g[S],b+=g[S],g[S]>v&&(v=g[S],y=S)}if(-1!=y){d/=b,m/=b;var A,w={x:d,y:m,z:b};A=MathUtils.getMinMax(f),w.minX=A[0],w.maxX=A[1],A=MathUtils.getMinMax(p),w.minY=A[0],w.maxY=A[1],a.push(w)}}return c},scanBitmask:function(t,e,i,r,n,s){0>r||0>n||n==i||r==e||t[r*i+n]&&(t[r*i+n]=0,s.push([n,r]),this.scanBitmask(t,e,i,r+1,n,s),this.scanBitmask(t,e,i,r-1,n,s),this.scanBitmask(t,e,i,r,n+1,s),this.scanBitmask(t,e,i,r,n-1,s))},createSignals2D:function(t,e,i){for(var r=[],n=(e.getNbSubSpectra(),e.observeFrequencyX()),s=e.observeFrequencyY(),a=e.getFirstY(),o=(e.getLastY(),e.getDeltaY()),h=t.length-1;h>=0;h--)t[h].x=e.arrayPointToUnits(t[h].x),t[h].y=a+o*t[h].y,(t[h].y<-1||t[h].y>=210)&&t.splice(h,1);var l=[],u=0;i*=i;for(var h=0;h<t.length;h++)for(var f=h;f<t.length;f++)u=Math.pow((t[h].x-t[f].x)*n,2)+Math.pow((t[h].y-t[f].y)*s,2),i>u?l.push(1):l.push(0);var p=SimpleClustering.fullClusterGenerator(l),r=[];if(null!=t)for(var g=0;g<p.length;g++){signal={nucleusX:e.getNucleus(1),nucleusY:e.getNucleus(2)},signal.resolutionX=(e.getLastX()-e.getFirstX())/e.getNbPoints(),signal.resolutionY=o;var c=[];signal.shiftX=0,signal.shiftY=0;for(var d=0,m=p[g].length-1;m>=0;m--)1==p[g][m]&&(c.push(t[m]),signal.shiftX+=t[m].x*t[m].z,signal.shiftY+=t[m].y*t[m].z,d+=t[m].z);signal.shiftX/=d,signal.shiftY/=d,signal.peaks=c,r.push(signal)}return r}},ESD=function(t){this.ESD2=t,this.nmrPeakDetection2D=function(t){return t=t||{},t.thresholdFactor||(t.thresholdFactor=1),PeakFinders2D._findPeaks2DLoG(this,t.thresholdFactor)},this.getNbPoints=function(){return this.getSpectraData(0).length/2},this.getSpectraData=function(t){return this.ESD2.spectra[t].data[0]},this.getYData=function(t){for(var e=new Array(this.getNbPoints()),i=this.getSpectraData(t),t=this.getNbPoints()-1;t>=0;t--)e[t]=i[2*t+1];return e},this.getNbSubSpectra=function(){return this.ESD2.spectra.length},this.isHomoNuclear=function(){return this.ESD2.xType==this.ESD2.yType},this.observeFrequencyX=function(){return this.ESD2.spectra[0].observeFrequency},this.observeFrequencyY=function(){return this.ESD2.indirectFrequency},this.arrayPointToUnits=function(t){return this.getFirstX()-t*(this.getFirstX()-this.getLastX())/(this.getNbPoints()-1)},this.getFirstX=function(){return this.ESD2.minMax.minX},this.getLastX=function(){return this.ESD2.minMax.maxX},this.getFirstY=function(){return this.ESD2.minMax.minY},this.getLastY=function(){return this.ESD2.minMax.maxY},this.getDeltaX=function(){return(this.getLastX()-this.getFirstX())/(this.getNbPoints()-1)},this.getDeltaY=function(){return(this.getLastY()-this.getFirstY())/(this.getNbSubSpectra()-1)},this.getNucleus=function(t){return 1==t?this.ESD2.xType:2==t?this.ESD2.yType:void 0}};define("src/sd",function(){}),function(t,e){"object"==typeof module&&"object"==typeof module.exports?module.exports=e(t):e(t)}(window,function(t){var e=function(t,e,i,r){function n(t,e,i){var n=[];for(var s in e)n.push($.get(e[s]).then(function(t){return r.convert(t,{keepSpectra:!0})}));t.divLoading||(t.divLoading=$("<div />").css({width:t.getDom().width(),height:t.getDom().height(),position:"absolute",backgroundColor:"rgba(200, 200, 200, 0.5)",textAlign:"center",lineHeight:t.getDom().height()+"px",fontSize:"2em",border:"1px solid #c0c0c0"}).html("Loading..."),t.getDom().prepend(t.divLoading)),t.loading=t.loading||0,t.loading++,$.when.apply($,n).then(function(){var r=0;for(s in e)e[s]=arguments[r],r++;t.loading--,0==t.loading&&(t.divLoading.remove(),t.divLoading=!1),t.series.push(e),t.loaded(e,i,"a"+Math.random())})}function s(t,e,i){var r=p.length;1==r&&(l=150/p[0].sum,u=p[0].sum);for(var n=0;r>n;n++){p[n].ratio=l;var s=Math.round(p[n].sum/u*100)/100;isNaN(s)||p[n].setLabelText(s),p[n].updateLabels()}}function a(t,e,i){g.push(i),t.graphs.selectedSerie?i.setSerie(t.graphs.selectedSerie):i.setSerie(t.graphs.getSerie(0)),i.integral=i,p.push(i)}function o(t,e,i){var r;(r=t.graphs[e].getSerie(i))&&r.kill(),t.graphs[e].redraw(),t.graphs[e].drawSeries()}function h(t){t.options.dom.append("<div />"),t.makeGraphs1D()}var l,u,f={mode:"1d",molecule:!1,urls:{}},p=[],g=[],c=function(r){this.options=$.extend(!0,{},f,r),this.series=[],this.minimapClip,t.registerConstructor("graph.shape.1dnmr",e);switch(this.graphs={x:null},this.integrals={x:[]},h(this),this.options.mode){case"2d":break;case"1d":this.legend=this.graphs.makeLegend({frame:!0,frameWidth:2,frameColor:"grey",movable:!0,backgroundColor:"white"}),this.legend.setPosition({x:"300px",y:"40px"},"right")}this.options.assignment&&(this.assignement=new i($.extend(this.options.assignment,{graphs:this.graphs,domGraphs:this.options.dom})))},d={urls:{}};return c.prototype.load=function(t){var t=$.extend(!0,{},d,t),e={};switch(this.options.mode){case"1d":t.urls.oneD=t.url||t.urls.oneD||t.urls.x,e.x=t.urls.oneD}n(this,e,t)},c.prototype.isSymmetric=function(){return this.options.symmetric||!1},c.prototype.getMode=function(){return this.options.mode},c.prototype.getDom=function(){return this.options.dom},c.prototype.getGraph2D=function(){return this.graphs._2d},c.prototype.getGraphX=function(){return this.graphs.x},c.prototype.getGraphY=function(){return this.graphs.y},c.prototype.resize1DTo=function(t,e){this.graphs.resize(t,e),this.graphs.drawSeries()},c.prototype.removeSerieX=function(t){o(this,"x",t)},c.prototype.setSerieX=function(t,e,i){this.graphs.getSerie(t)&&(this.graphs.getSerie(t).kill(),this.graphs.removeShapes(),this.integralBasis=!1);var r=this.graphs.newSerie(t,$.extend({useSlots:!0},i)).setLabel("My serie").autoAxis().setData(e).XIsMonotoneous();i.lineColor&&r.setLineColor(i.lineColor),i.lineWidth&&r.setLineWidth(i.lineWidth),i.setLineStyle&&r.setLineStyle(i.lineStyle),r.XIsMonotoneous(),r.getXAxis().setAxisDataSpacingMax(0),r.getXAxis().setAxisDataSpacingMin(0),r.getYAxis().setDisplay(!1).primaryGridOff(!1).secondaryGridOff(!1),r.getXAxis().flip(!0).setLabel("ppm").primaryGridOff(!1).secondaryGridOff(!1).setTickPosition("outside"),this.graphs.autoscaleAxes(),this.graphs.draw()},c.prototype.loaded=function(t,e,i){switch(this.getMode()){case"1d":this.setSerieX(i,t.x.spectra[0].data[0],{label:"SomeLabel"})}},c.prototype.makeGraphs1D=function(){var e=this;this.graphs=new t(this.getDom().children().get(0),{close:{left:!1,top:!1,right:!1},paddingBottom:0,paddingTop:0,paddingLeft:0,paddingRight:0,plugins:{zoom:{zoomMode:"x"},shape:{type:"nmrintegral",strokeColor:"#AF002A",fillColor:"transparent",strokeWidth:2,locked:!1,movable:!0,resizable:!0,selectable:!0,selectOnMouseDown:!0,handles:!0,labelEditable:!0,horizontal:!0,forcedCoords:{y:function(t){return 20+5*t.serie.getIndex()+"px"}},bindable:!0,axis:"x",labels:[{text:"Something",color:"red"}],attributes:{"data-bindable":function(){return 1}},onCreatedShape:function(t){t.setSerie(e.graphs.getSerie(0)),a(e,"x",t)},highlightOnMouseOver:!0}},dblclick:{type:"plugin",plugin:"zoom",options:{mode:"total"}},wheel:{type:"plugin",plugin:"zoom",options:{direction:"y",baseline:0}},pluginAction:{zoom:{shift:!1,ctrl:!1},shape:{shift:!0,ctrl:!1}},onBeforeNewShape:function(){return!this.selectedSerie&&this.series.length>1?!1:void 0}}),this.graphs.setHeight(300),this.graphs.on("shapeChanged",function(t){"nmrintegral"==t.getType()&&s(e)}),this.graphs.on("shapeLabelChanged",function(t){if("nmrintegral"==t.getType()){var i=parseFloat(t.getLabelText(0));u=t.sum/i,s(e)}}),this.graphs.redraw(),this.graphs.drawSeries()},c};if("function"==typeof define&&define.amd)define("src/nmr.js",["jsgraph","./shape.1dnmr","./assignment","jcampconverter","./sd"],function(t,i,r,n,s){return e(t,i,r,n)});else if(t){if(!(t.Graph&&t.Assignment&&t.JcampConverter))throw"Graph, Assignment or Jcamp is not defined";t.NMRHandler=e(t.Graph,t.Shape1DNMR,t.Assignment,t.JcampConverter)}});
//# sourceMappingURL=jsnmr.min.js.map